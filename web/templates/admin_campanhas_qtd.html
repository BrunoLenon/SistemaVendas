{% extends "base.html" %}

{% block title %}Admin ‚Äî Campanhas{% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:700; letter-spacing:-.3px}
  .subtitle{color:var(--bs-secondary-color)}
  .mono{font-variant-numeric: tabular-nums;}
  .kpi{display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .65rem; border-radius:999px; background:rgba(13,110,253,.08); color:#0d6efd; font-size:.85rem}
  .card-soft{border-radius:1rem}
    .table thead th{white-space:nowrap}
  .truncate{max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .form-grid .form-control, .form-grid .form-select{border-radius:.75rem}
  .table td, .table th{vertical-align:middle}
  .col-base{min-width:260px}
  .col-vendedor{min-width:140px}
  .col-marca{min-width:140px}
  .col-vigencia{min-width:140px}
  .actions{white-space:nowrap}
  @media (max-width: 768px){
    .col-base{min-width:200px}
  }
  @media (max-width: 991px){
        .truncate{max-width:220px}
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <h3 class="m-0 page-title">Campanhas</h3>
        <span class="kpi">Admin ‚Ä¢ Qtd / Recompensa</span>
      </div>
      <div class="subtitle mt-1">
        Crie campanhas por <b>c√≥digo (prefixo)</b> ou por <b>descri√ß√£o (come√ßa com)</b>. A <b>marca</b> √© sempre obrigat√≥ria.
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dashboard') }}">Voltar</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('auth.logout') }}">Sair</a>
    </div>
  </div>

  {% if erro %}
    <div class="alert alert-danger shadow-sm">{{ erro }}</div>
  {% endif %}
  {% if ok %}
    <div class="alert alert-success shadow-sm">{{ ok }}</div>
  {% endif %}

  <div class="row g-3">

    <div class="col-12">
<div class="card shadow-sm card-soft">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
              <div>
                <div class="fw-semibold">Nova campanha</div>
                <div class="subtitle small">Preencha e clique em <b>Salvar</b>. Campos com * s√£o obrigat√≥rios.</div>
              </div>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#tipsCollapse" aria-expanded="false">
                Dicas
              </button>
            </div>

            <div class="collapse" id="tipsCollapse">
              <div class="alert alert-light border small mb-3">
                <div class="fw-semibold mb-1">Boas pr√°ticas</div>
                <ul class="mb-0">
                  <li><b>C√≥digo</b>: use prefixo (ex.: <code>406</code>) para pegar todos os c√≥digos que come√ßam com isso.</li>
                  <li><b>Descri√ß√£o</b>: use o in√≠cio exato (ex.: <code>JOGO JUNTA</code>) e selecione a marca.</li>
                  <li><b>Qtd/Valor m√≠nimo</b>: opcionais. Se preencher os dois, ambos ser√£o exigidos.</li>
                </ul>
              </div>
            </div>

            <form method="post" class="row g-2" id="frmCampanha">
              <input type="hidden" name="acao" value="criar">

              <div class="col-6">
                <label class="form-label">EMP *</label>
                <input class="form-control" type="text" name="emp" placeholder="ex: 101" required>
              </div>

              <div class="col-6">
                <label class="form-label">Vendedor</label>
                <input class="form-control" type="text" name="vendedor" placeholder="vazio = todos">
                <div class="form-text">Opcional ‚Ä¢ se vazio, vale para todos da EMP.</div>
              </div>

              <div class="col-12">
                <label class="form-label">T√≠tulo</label>
                <input class="form-control" type="text" name="titulo" placeholder="ex: Semana do Pneu">
              </div>

              <div class="col-12">
                <label class="form-label">Base *</label>
                <select class="form-select" name="campo_match" id="campo_match">
                  <option value="codigo" selected>C√≥digo / Prefixo</option>
                  <option value="descricao">Descri√ß√£o (come√ßa com...)</option>
                </select>
                <div class="form-text">Escolha <b>uma</b> base. O outro campo ser√° desativado automaticamente.</div>
              </div>

              <div class="col-12">
                <label class="form-label">Produto (prefixo)</label>
                <input class="form-control" type="text" name="produto_prefixo" id="produto_prefixo" placeholder="ex: 406">
              </div>

              <div class="col-12">
                <label class="form-label">Descri√ß√£o (in√≠cio)</label>
                <input class="form-control" type="text" name="descricao_prefixo" id="descricao_prefixo" placeholder="ex: JOGO JUNTA">
              </div>

              <div class="col-6">
                <label class="form-label">Marca *</label>
                <input class="form-control" type="text" name="marca" placeholder="ex: COFAP" required>
              </div>

              <div class="col-6">
                <label class="form-label">Recompensa (R$/un) *</label>
                <input class="form-control" type="text" name="recompensa_unit" placeholder="1,00" required>
              </div>

              <div class="col-6">
                <label class="form-label">Qtd m√≠nima</label>
                <input class="form-control" type="text" name="qtd_minima" inputmode="numeric" placeholder="ex: 50">
              </div>

              <div class="col-6">
                <label class="form-label">Valor m√≠nimo</label>
                <input class="form-control" type="text" name="valor_minimo" placeholder="ex: 1000,00">
              </div>

              <div class="col-6">
                <label class="form-label">In√≠cio *</label>
                <input class="form-control" type="date" name="data_inicio" required>
              </div>

              <div class="col-6">
                <label class="form-label">Fim *</label>
                <input class="form-control" type="date" name="data_fim" required>
              </div>

              <div class="col-12 d-grid mt-2">
                <button class="btn btn-primary" type="submit" id="btnSalvar">
                  <span class="spinner-border spinner-border-sm d-none" id="spSalvar" role="status" aria-hidden="true"></span>
                  <span id="txSalvar">Salvar campanha</span>
                </button>
              </div>
            </form>

          </div>
      </div>
    </div>
    </div>

    <div class="col-12">
<div class="card shadow-sm card-soft">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
            <div>
              <div class="fw-semibold">Campanhas cadastradas</div>
              <div class="subtitle small">Filtre rapidamente e gerencie abaixo.</div>
            </div>

            <div class="d-flex flex-wrap gap-2">
              <div class="input-group input-group-sm" style="min-width:240px">
                <span class="input-group-text">üîé</span>
                <input type="text" class="form-control" id="qSearch" placeholder="Buscar (t√≠tulo, vendedor, marca...)">
              </div>

              <select class="form-select form-select-sm" id="empFilter" style="width:auto; min-width:140px">
                <option value="ALL" selected>Todas EMP</option>
                {% set grouped_emps = campanhas|groupby('emp') %}
                {% for g in grouped_emps %}
                  {% if g.grouper %}
                    <option value="{{ g.grouper }}">EMP {{ g.grouper }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>

          {% if campanhas|length == 0 %}
            <div class="text-center text-muted py-4">Nenhuma campanha cadastrada.</div>
          {% else %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblCampanhas">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>EMP</th>
                    <th class="col-base">T√≠tulo / Base</th>
                    <th class="col-vendedor">Vendedor</th>
                    <th class="col-marca">Marca</th>
                    <th class="text-end">M√≠nimos</th>
                    <th class="text-end">R$/un</th>
                    <th class="col-vigencia">Vig√™ncia</th>
                    <th class="text-end actions">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for grp in campanhas|sort(attribute='data_inicio', reverse=True)|groupby('competencia_label') %}
                    <tr class="table-light">
                      <td colspan="10" class="fw-semibold">{{ grp.grouper or 'Sem compet√™ncia' }}</td>
                    </tr>
                    {% for c in grp.list %}
                    <tr data-emp="{{ c.emp or '' }}" data-search="{{ (c.titulo or '') ~ ' ' ~ (c.vendedor or '') ~ ' ' ~ (c.marca or '') ~ ' ' ~ (c.produto_prefixo or '') ~ ' ' ~ (c.descricao_prefixo or '') }}">
                      <td class="mono">{{ c.id }}</td>
                      <td class="mono">{{ c.emp or '-' }}</td>
                      <td>
                        <div class="fw-semibold truncate" title="{{ c.titulo or '' }}">{{ c.titulo or '-' }}</div>
                        <div class="small text-muted">
                          {% if c.campo_match == 'codigo' %}
                            <span class="badge text-bg-light border">C√≥digo</span>
                            <span class="mono">{{ c.produto_prefixo or '-' }}</span>
                          {% else %}
                            <span class="badge text-bg-light border">Descri√ß√£o</span>
                            <span class="truncate d-inline-block" style="vertical-align:bottom" title="{{ c.descricao_prefixo or '' }}">{{ c.descricao_prefixo or '-' }}</span>
                          {% endif %}
                        </div>
                      </td>
                      <td>{{ c.vendedor or 'TODOS' }}</td>
                      <td class="mono">{{ c.marca or '-' }}</td>
                      <td class="text-end mono">
                        {% if c.qtd_minima %}{{ c.qtd_minima }}{% else %}-{% endif %}
                        <span class="text-muted">/</span>
                        {% if c.valor_minimo %}R$ {{ '%.2f'|format(c.valor_minimo) }}{% else %}-{% endif %}
                      </td>
                      <td class="text-end mono">R$ {{ '%.2f'|format(c.recompensa_unit or 0) }}</td>
                      <td class="small">
                        {{ c.data_inicio.strftime('%d/%m/%Y') if c.data_inicio else '-' }}<br>
                        {{ c.data_fim.strftime('%d/%m/%Y') if c.data_fim else '-' }}
                      </td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" type="button"
                                data-bs-toggle="modal" data-bs-target="#delModal"
                                data-id="{{ c.id }}" data-title="{{ c.titulo or ('Campanha #' ~ c.id) }}">
                          Excluir
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                    {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="subtitle small mt-2">
              Mostrando <span class="mono" id="rowCount">{{ campanhas|length }}</span> campanha(s).
            </div>
          {% endif %}

        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal excluir -->
<div class="modal fade" id="delModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border-radius:1rem">
      <div class="modal-header">
        <div>
          <div class="fw-semibold">Confirmar exclus√£o</div>
          <div class="subtitle small" id="delTitle">Campanha</div>
        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-0">
          Essa a√ß√£o n√£o pode ser desfeita.
        </div>
      </div>
      <div class="modal-footer">
        <form method="post" id="delForm" class="m-0">
          <input type="hidden" name="acao" value="remover">
          <input type="hidden" name="campanha_id" id="delId" value="">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger" type="submit">Excluir</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Toggle campos por base
  function toggleMatchFields() {
    var sel = document.getElementById('campo_match');
    var tipo = (sel && sel.value) ? sel.value : 'codigo';
    var cod = document.getElementById('produto_prefixo');
    var desc = document.getElementById('descricao_prefixo');
    if(!cod || !desc) return;

    if(tipo === 'descricao'){
      desc.required = true;
      cod.required = false;
      cod.value = '';
      cod.disabled = true;
      cod.classList.add('bg-light');
      desc.disabled = false;
      desc.classList.remove('bg-light');
      desc.focus();
    } else {
      cod.required = true;
      desc.required = false;
      desc.value = '';
      desc.disabled = true;
      desc.classList.add('bg-light');
      cod.disabled = false;
      cod.classList.remove('bg-light');
      cod.focus();
    }
  }
  document.addEventListener('change', function(e){
    if(e && e.target && e.target.id === 'campo_match') toggleMatchFields();
  });
  toggleMatchFields();

  // UX: bot√£o salvar loading
  var frm = document.getElementById('frmCampanha');
  if(frm){
    frm.addEventListener('submit', function(){
      var b = document.getElementById('btnSalvar');
      var sp = document.getElementById('spSalvar');
      var tx = document.getElementById('txSalvar');
      if(b){ b.disabled = true; }
      if(sp){ sp.classList.remove('d-none'); }
      if(tx){ tx.textContent = 'Salvando...'; }
    });
  }

  // Modal excluir
  var delModal = document.getElementById('delModal');
  if(delModal){
    delModal.addEventListener('show.bs.modal', function(event){
      var btn = event.relatedTarget;
      var id = btn.getAttribute('data-id');
      var title = btn.getAttribute('data-title');
      document.getElementById('delId').value = id;
      document.getElementById('delTitle').textContent = title;
    });
  }

  // Filtro client-side
  function applyFilters(){
    var q = (document.getElementById('qSearch')?.value || '').toLowerCase().trim();
    var emp = document.getElementById('empFilter')?.value || 'ALL';
    var rows = document.querySelectorAll('#tblCampanhas tbody tr');
    var shown = 0;

    rows.forEach(function(r){
      var okEmp = (emp === 'ALL') || (String(r.getAttribute('data-emp')||'') === String(emp));
      var hay = String(r.getAttribute('data-search')||'').toLowerCase();
      var okQ = (!q) || (hay.indexOf(q) >= 0);
      var show = okEmp && okQ;
      r.style.display = show ? '' : 'none';
      if(show) shown++;
    });

    var rc = document.getElementById('rowCount');
    if(rc) rc.textContent = shown;
  }

  var qs = document.getElementById('qSearch');
  var ef = document.getElementById('empFilter');
  if(qs){ qs.addEventListener('input', applyFilters); }
  if(ef){ ef.addEventListener('change', applyFilters); }
  applyFilters();
})();
</script>
{% endblock %}
