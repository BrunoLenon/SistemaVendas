{% extends "base.html" %}
{% block title %}Relatórios • Campanhas{% endblock %}
{% block content %}

{% set view_mode = request.args.get('view', 'detalhado') %}
{% set resumo = ctx.get('resumo', {}) %}
{% set status = resumo.get('status', {}) %}

<div class="sv-page">

  <!-- Header -->
  <div class="sv-pagehead sv-glass">
    <div class="sv-pagehead__left">
      <div class="sv-breadcrumb">Relatórios <span class="sv-muted">/</span> Campanhas</div>
      <h1 class="sv-h1">Campanhas do mês</h1>
      <div class="sv-sub">Filtre por EMP e vendedor. Use <strong>Recalcular</strong> quando importar vendas.</div>
    </div>
    <div class="sv-pagehead__right">
      <a class="sv-btn sv-btn-ghost" href="{{ ctx.get('recalc_url') or url_for('relatorio_campanhas', recalc=1, page=1) }}">
        Recalcular
      </a>
      <a class="sv-btn sv-btn-primary" href="{{ ctx.get('export_url') or url_for('relatorio_campanhas_export_csv') }}">
        Exportar CSV
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div class="sv-card sv-glass sv-section">
    <form method="get" action="{{ url_for('relatorio_campanhas') }}">
      <div class="sv-grid sv-grid-3">
        <div class="sv-field">
          <label class="sv-label">Mês</label>
          <select class="sv-select" name="mes">
            {% for m in range(1,13) %}
              <option value="{{ m }}" {% if (m|string) == (mes|string) %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="sv-field">
          <label class="sv-label">Ano</label>
          <input class="sv-input" name="ano" value="{{ ano }}" inputmode="numeric">
        </div>

        <div class="sv-field">
          <label class="sv-label">Visão</label>
          <select class="sv-select" name="view">
            <option value="detalhado" {% if view_mode != "vendedores" %}selected{% endif %}>Detalhado</option>
            <option value="vendedores" {% if view_mode == "vendedores" %}selected{% endif %}>Por vendedor (recompensas)</option>
          </select>
        </div>
      </div>

      <div class="sv-grid sv-grid-2 sv-mt">
        <div class="sv-card sv-filterbox">
          <div class="sv-filterbox__head">
            <div>
              <div class="sv-label-inline">EMP</div>
              <div class="sv-muted sv-small">Selecione uma ou mais</div>
            </div>
            <button type="button" class="sv-btn sv-btn-ghost sv-btn-xs" data-sv-checkall="emp">Marcar todas</button>
          </div>
          <div class="sv-checklist">
            {% for e in emps_scope %}
              {% set checked = (e in emps_sel) %}
              <label class="sv-check">
                <input type="checkbox" name="emp" value="{{ e }}" {% if checked %}checked{% endif %}>
                <span>{{ e }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="sv-card sv-filterbox">
          <div class="sv-filterbox__head">
            <div>
              <div class="sv-label-inline">Vendedor</div>
              <div class="sv-muted sv-small">Opcional</div>
            </div>
            <button type="button" class="sv-btn sv-btn-ghost sv-btn-xs" data-sv-checkall="vendedor">Marcar todas</button>
          </div>
          <div class="sv-checklist">
            {% for v in vendedores_scope %}
              {% set checked = (v in vendedores_sel) %}
              <label class="sv-check">
                <input type="checkbox" name="vendedor" value="{{ v }}" {% if checked %}checked{% endif %}>
                <span>{{ v }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="sv-actions sv-mt">
        <div class="sv-muted sv-small">
          Linhas: {{ total_rows }} • Por página:
          <select class="sv-select sv-select-xs" name="per_page">
            {% for opt in per_page_opts %}
              <option value="{{ opt }}" {% if (opt|string) == (per_page|string) %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="sv-actions__right">
          <button class="sv-btn sv-btn-primary" type="submit">Aplicar filtros</button>
          <a class="sv-btn sv-btn-ghost" href="{{ url_for('relatorio_campanhas') }}">Limpar</a>
        </div>
      </div>
    </form>
  </div>

  <!-- KPI -->
  <div class="sv-kpi-grid sv-section">
    <div class="sv-card sv-glass sv-kpi">
      <div class="sv-kpi__label">Total (R$)</div>
      <div class="sv-kpi__value">{{ resumo.get('total_valor', 0.0) | brl_rs }}</div>
      <div class="sv-kpi__meta">{{ resumo.get('linhas', 0) }} linhas</div>
    </div>
    <div class="sv-card sv-glass sv-kpi">
      <div class="sv-kpi__label">Pendente</div>
      <div class="sv-kpi__value">{{ status.get('PENDENTE', 0.0) | brl_rs }}</div>
      <div class="sv-kpi__meta">Aguardando fechamento</div>
    </div>
    <div class="sv-card sv-glass sv-kpi">
      <div class="sv-kpi__label">A Pagar</div>
      <div class="sv-kpi__value">{{ status.get('A_PAGAR', 0.0) | brl_rs }}</div>
      <div class="sv-kpi__meta">Pronto para pagar</div>
    </div>
    <div class="sv-card sv-glass sv-kpi">
      <div class="sv-kpi__label">Pago</div>
      <div class="sv-kpi__value">{{ status.get('PAGO', 0.0) | brl_rs }}</div>
      <div class="sv-kpi__meta">Já liquidado</div>
    </div>
  </div>

  {% if view_mode == "vendedores" %}
    <!-- Vendedor ranking -->
    <div class="sv-card sv-glass sv-section">
      <div class="sv-sectionhead">
        <h2 class="sv-h2">Ranking por vendedor (recompensas)</h2>
        <div class="sv-muted sv-small">Somatório da recompensa do período filtrado</div>
      </div>

      {% set por_emp = resumo.get('por_emp', {}) %}
      {% if resumo.get('por_emp_ordenado') %}
        <div class="sv-accordion">
          {% for emp, empd in resumo.get('por_emp_ordenado', []) %}
            <details class="sv-accitem" {% if loop.index == 1 %}open{% endif %}>
              <summary class="sv-accsum">
                <div class="sv-accsum__left">
                  <span class="sv-badge">{{ emp }}</span>
                  <span class="sv-muted">•</span>
                  <span class="sv-strong">{{ empd.get('total', 0.0) | brl_rs }}</span>
                </div>
                <div class="sv-accsum__right">
                  <span class="sv-pill sv-pill-warn">Pendente {{ empd.get('status', {}).get('PENDENTE', 0.0) | brl_rs }}</span>
                  <span class="sv-pill sv-pill-info">A Pagar {{ empd.get('status', {}).get('A_PAGAR', 0.0) | brl_rs }}</span>
                  <span class="sv-pill sv-pill-ok">Pago {{ empd.get('status', {}).get('PAGO', 0.0) | brl_rs }}</span>
                </div>
              </summary>

              {% set vend_map = empd.get('vendedores', {}) %}
              {% set vend_items = vend_map.items()|list %}
              {% set vend_sorted = vend_items|sort(attribute=1.total, reverse=True) %}
              <div class="sv-tablewrap">
                <table class="sv-table">
                  <thead>
                    <tr>
                      <th>Vendedor</th>
                      <th class="sv-right">Linhas</th>
                      <th class="sv-right">Total (R$)</th>
                      <th class="sv-right">Pendente</th>
                      <th class="sv-right">A Pagar</th>
                      <th class="sv-right">Pago</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for vend, vd in vend_sorted %}
                      <tr>
                        <td>{{ vend }}</td>
                        <td class="sv-right">{{ vd.get('linhas', 0) }}</td>
                        <td class="sv-right sv-strong">{{ vd.get('total', 0.0) | brl_rs }}</td>
                        <td class="sv-right">{{ vd.get('status', {}).get('PENDENTE', 0.0) | brl_rs }}</td>
                        <td class="sv-right">{{ vd.get('status', {}).get('A_PAGAR', 0.0) | brl_rs }}</td>
                        <td class="sv-right">{{ vd.get('status', {}).get('PAGO', 0.0) | brl_rs }}</td>
                      </tr>
                    {% endfor %}
                    {% if vend_sorted|length == 0 %}
                      <tr><td colspan="6" class="sv-muted">Sem dados para os filtros escolhidos.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <div class="sv-muted">Sem dados para os filtros escolhidos.</div>
      {% endif %}
    </div>
  {% endif %}

  <!-- Detalhado -->
  <div class="sv-card sv-glass sv-section">
    <div class="sv-sectionhead">
      <h2 class="sv-h2">Tabela detalhada</h2>
      <div class="sv-muted sv-small">
        Página {{ page }} de {{ total_pages }}
      </div>
    </div>

    <div class="sv-tablewrap">
      <table class="sv-table sv-table--grouped">
        <thead>
          <tr>
            <th>EMP</th>
            <th>Vendedor</th>
            <th>Campanhas</th>
            <th class="sv-right">Total (R$)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% set groups = rows_grouped_page|default(ctx.get('rows_grouped_page', [])) %}
          {% for g in groups %}
            <tr>
              <td class="sv-mono">{{ g.emp }}</td>
              <td>
                <div class="sv-strong">{{ g.vendedor }}</div>
                <div class="sv-muted">Campanhas: {{ g.campanhas_count }} • Total: {{ g.total|brl_rs }}</div>
              </td>
              <td>
                <details class="sv-acc sv-acc--inline">
                  <summary class="sv-acc__sum">
                    <span class="sv-acc__label">Ver campanhas ({{ g.campanhas_count }})</span>
                    <span class="sv-acc__chev" aria-hidden="true"></span>
                  </summary>
                  <div class="sv-acc__body">
                    <table class="sv-subtable">
                      <thead>
                        <tr>
                          <th>Campanha</th>
                          <th class="sv-right">Valor</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for c in g.campanhas %}
                          <tr>
                            <td>{{ c.titulo }}</td>
                            <td class="sv-right">{{ c.valor|brl_rs }}</td>
                            <td>
                              <span class="sv-pill {{ 'sv-pill-warn' if c.status=='PENDENTE' else ('sv-pill-info' if c.status=='A_PAGAR' else ('sv-pill-ok' if c.status=='PAGO' else '')) }}">{{ c.status }}</span>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </details>
              </td>
              <td class="sv-right">{{ g.total|brl_rs }}</td>
              <td>
                <span class="sv-pill {{ 'sv-pill-warn' if g.status=='PENDENTE' else ('sv-pill-info' if g.status=='A_PAGAR' else ('sv-pill-ok' if g.status=='PAGO' else '')) }}">{{ g.status }}</span>
              </td>
            </tr>
          {% endfor %}
          {% if groups|length == 0 %}
            <tr><td colspan="5" class="sv-muted">Sem dados para os filtros escolhidos.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="sv-pager">
      <a class="sv-btn sv-btn-ghost" href="{{ ctx.prev_url }}">◀ Anterior</a>
      <div class="sv-muted sv-small">Página {{ page }} de {{ total_pages }}</div>
      <a class="sv-btn sv-btn-ghost" href="{{ ctx.next_url }}">Próxima ▶</a>
    </div>
  </div>

</div>

<script>
  // "Marcar todas" para checklists
  (function(){
    function checkAll(name){
      var inputs = document.querySelectorAll('input[type="checkbox"][name="'+name+'"]');
      var anyUnchecked = false;
      inputs.forEach(function(i){ if(!i.checked) anyUnchecked = true; });
      inputs.forEach(function(i){ i.checked = anyUnchecked; });
    }
    document.querySelectorAll('[data-sv-checkall]').forEach(function(btn){
      btn.addEventListener('click', function(){
        checkAll(btn.getAttribute('data-sv-checkall'));
      });
    });
  })();
</script>

{% endblock %}
