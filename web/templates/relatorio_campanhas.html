{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-0">Relatório de Campanhas</h3>
      <div class="text-muted small">Unificado (Qtd • Combo • Itens Parados) — competência {{ mes }}/{{ ano }}</div>
    </div>
    <div class="d-flex gap-2">
      {% if recalc_url %}
        <a class="btn btn-outline-primary" href="{{ recalc_url }}">Recalcular agora</a>
      {% endif %}
      {% if export_url %}
        <a class="btn btn-outline-secondary" href="{{ export_url }}">Exportar CSV</a>
      {% endif %}
    </div>
  </div>

  <!-- Filtros -->
  <form method="get" class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-6 col-md-2">
          <label class="form-label">Mês</label>
          <input type="number" name="mes" min="1" max="12" class="form-control" value="{{ mes }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Ano</label>
          <input type="number" name="ano" min="2020" max="2100" class="form-control" value="{{ ano }}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">EMP (selecione uma ou mais)</label>
          <div class="border rounded p-2" style="max-height: 170px; overflow:auto;">
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Buscar</span>
              <input class="form-control" type="text" oninput="filterChecks(this,'emp-check')" placeholder="101...">
              <button class="btn btn-outline-secondary" type="button" onclick="toggleAll('emp-check', true)">Todas</button>
              <button class="btn btn-outline-secondary" type="button" onclick="toggleAll('emp-check', false)">Nenhuma</button>
            </div>
            <div class="d-flex flex-wrap gap-3">
              {% for e in emps_scope %}
                {% set checked = (e in emps_sel) %}
                <label class="form-check form-check-inline m-0 emp-check">
                  <input class="form-check-input" type="checkbox" name="emp" value="{{ e }}" {% if checked %}checked{% endif %}>
                  <span class="form-check-label">{{ e }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Vendedor (opcional)</label>
          <div class="border rounded p-2" style="max-height: 170px; overflow:auto;">
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Buscar</span>
              <input class="form-control" type="text" oninput="filterChecks(this,'vend-check')" placeholder="NOME...">
              <button class="btn btn-outline-secondary" type="button" onclick="toggleAll('vend-check', true)">Todos</button>
              <button class="btn btn-outline-secondary" type="button" onclick="toggleAll('vend-check', false)">Nenhum</button>
            </div>
            <div class="d-flex flex-wrap gap-3">
              {% for v in vendedores_scope %}
                {% set checked = (v in vendedores_sel) %}
                <label class="form-check form-check-inline m-0 vend-check">
                  <input class="form-check-input" type="checkbox" name="vendedor" value="{{ v }}" {% if checked %}checked{% endif %}>
                  <span class="form-check-label">{{ v }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="col-12 d-flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">Aplicar filtros</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('relatorio_campanhas') }}">Limpar</a>

          <div class="ms-auto d-flex align-items-center gap-2">
            <span class="text-muted small">Linhas:</span>
            <strong>{{ total_rows }}</strong>
            <span class="text-muted small ms-3">Por página:</span>
            <div class="btn-group btn-group-sm">
              {% for opt in per_page_opts %}
                <a class="btn btn-outline-secondary {% if opt==per_page %}active{% endif %}" href="{{ per_page_urls[opt] }}">{{ opt }}</a>
              {% endfor %}
            </div>
          </div>
        </div>

      </div>
    </div>
  </form>

  <!-- Resumo Financeiro -->
  {% if resumo %}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Total Geral</div>
          <div class="fs-4 fw-bold">R$ {{ "%.2f"|format(resumo.total_valor) }}</div>
          <div class="text-muted small">Linhas: {{ resumo.linhas }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Pendente</div>
          <div class="fs-4 fw-bold">R$ {{ "%.2f"|format(resumo.status.PENDENTE) }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">A pagar</div>
          <div class="fs-4 fw-bold">R$ {{ "%.2f"|format(resumo.status.A_PAGAR) }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Pago</div>
          <div class="fs-4 fw-bold">R$ {{ "%.2f"|format(resumo.status.PAGO) }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>Resumo por EMP e Vendedor</strong>
      <span class="text-muted small">Ordenado por maior recompensa</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>EMP</th>
              <th class="text-end">Total (R$)</th>
              <th class="text-end">Pendente</th>
              <th class="text-end">A pagar</th>
              <th class="text-end">Pago</th>
              <th>Vendedores (top)</th>
            </tr>
          </thead>
          <tbody>
            {% for emp, ed in resumo.por_emp_ordenado %}
              <tr>
                <td><strong>{{ emp }}</strong></td>
                <td class="text-end"><strong>{{ "%.2f"|format(ed.total) }}</strong></td>
                <td class="text-end">{{ "%.2f"|format(ed.status.PENDENTE) }}</td>
                <td class="text-end">{{ "%.2f"|format(ed.status.A_PAGAR) }}</td>
                <td class="text-end">{{ "%.2f"|format(ed.status.PAGO) }}</td>
                <td class="small">
                  {% set vend_items = ed.vendedores.items()|list %}
                  {% set vend_sorted = vend_items|sort(attribute=1.total, reverse=True) %}
                  {% for vname, vd in vend_sorted[:5] %}
                    <span class="badge bg-light text-dark border">{{ vname }}: R$ {{ "%.2f"|format(vd.total) }}</span>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Detalhamento EMP -> Vendedor -> Campanhas -->
  <div class="card">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
      <strong>Detalhamento (agrupado)</strong>
      <div class="text-muted small">
        Página {{ page }} / {{ total_pages }} • {{ total_rows }} linhas
        <span class="ms-2">
          <a class="btn btn-sm btn-outline-secondary {% if page<=1 %}disabled{% endif %}" href="{{ prev_url }}">Anterior</a>
          <a class="btn btn-sm btn-outline-secondary {% if page>=total_pages %}disabled{% endif %}" href="{{ next_url }}">Próxima</a>
        </span>
      </div>
    </div>

    <div class="card-body p-0">
      {% if rows_page and rows_page|length > 0 %}

        {# Ordena para garantir agrupamento estável #}
        {% set rows_sorted = rows_page|sort(attribute='emp') %}

        <div class="accordion" id="accEmp">
          {% set ns = namespace(last_emp=None, last_vend=None, emp_idx=0, vend_idx=0) %}

          {% for r in rows_page|sort(attribute='emp') %}
            {% if ns.last_emp != r.emp %}
              {# fecha vendedor e emp anteriores #}
              {% if ns.last_emp is not none %}
                    </tbody></table>
                  </div>
                </div>
              </div>  {# end accordion-item vendedor #}
            </div>      {# end accordion vendedores EMP #}
          </div>        {# end accordion-item EMP #}
              {% endif %}

              {% set ns.emp_idx = ns.emp_idx + 1 %}
              {% set ns.vend_idx = 0 %}
              {% set ns.last_emp = r.emp %}
              {% set ns.last_vend = None %}

              <div class="accordion-item">
                <h2 class="accordion-header" id="emp-h-{{ ns.emp_idx }}">
                  <button class="accordion-button {% if ns.emp_idx>1 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#emp-c-{{ ns.emp_idx }}">
                    <span class="me-2">EMP</span>
                    <span class="badge bg-dark">{{ r.emp }}</span>
                  </button>
                </h2>
                <div id="emp-c-{{ ns.emp_idx }}" class="accordion-collapse collapse {% if ns.emp_idx==1 %}show{% endif %}" data-bs-parent="#accEmp">
                  <div class="accordion-body pt-2">

                    <div class="accordion" id="accVend-{{ ns.emp_idx }}">
            {% endif %}

            {% if ns.last_vend != r.vendedor %}
              {% if ns.last_vend is not none %}
                        </tbody></table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              {% set ns.vend_idx = ns.vend_idx + 1 %}
              {% set ns.last_vend = r.vendedor %}

              <div class="accordion-item">
                <h2 class="accordion-header" id="vend-h-{{ ns.emp_idx }}-{{ ns.vend_idx }}">
                  <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#vend-c-{{ ns.emp_idx }}-{{ ns.vend_idx }}">
                    <span class="me-2">Vendedor</span>
                    <span class="badge bg-secondary">{{ r.vendedor }}</span>
                  </button>
                </h2>
                <div id="vend-c-{{ ns.emp_idx }}-{{ ns.vend_idx }}" class="accordion-collapse collapse" data-bs-parent="#accVend-{{ ns.emp_idx }}">
                  <div class="accordion-body p-0">

                    <div class="table-responsive">
                      <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>Tipo</th>
                            <th>Campanha</th>
                            <th class="text-center">Gate</th>
                            <th class="text-end">Qtd/Base</th>
                            <th class="text-end">Qtd Premiada</th>
                            <th class="text-end">Valor (R$)</th>
                            <th>Status</th>
                            <th>Pago em</th>
                          </tr>
                        </thead>
                        <tbody>
            {% endif %}

                          <tr>
                            <td><span class="badge bg-info text-dark">{{ r.tipo }}</span></td>
                            <td>
                              <div class="fw-semibold">{{ r.titulo or r.campanha }}</div>
                              {% if r.campanha and r.titulo and r.campanha != r.titulo %}
                                <div class="text-muted small">{{ r.campanha }}</div>
                              {% endif %}
                            </td>
                            <td class="text-center">
                              {% if r.atingiu_gate %}
                                <span class="badge bg-success">SIM</span>
                              {% else %}
                                <span class="badge bg-danger">NÃO</span>
                              {% endif %}
                            </td>
                            <td class="text-end">{{ r.qtd_base }}</td>
                            <td class="text-end">{{ r.qtd_premiada }}</td>
                            <td class="text-end fw-semibold">{{ "%.2f"|format(r.valor_recompensa or 0) }}</td>
                            <td>
                              {% set st = (r.status_pagamento or "PENDENTE")|upper %}
                              {% if st in ["PAGO"] %}
                                <span class="badge bg-success">PAGO</span>
                              {% elif st in ["A_PAGAR","A PAGAR"] %}
                                <span class="badge bg-warning text-dark">A PAGAR</span>
                              {% else %}
                                <span class="badge bg-secondary">PENDENTE</span>
                              {% endif %}
                            </td>
                            <td class="text-muted small">{{ r.pago_em or "" }}</td>
                          </tr>

          {% endfor %}

          {# fecha o último vendedor e EMP #}
                        </tbody></table>
                      </div>
                    </div>
                  </div>
                </div>
              </div> {# end accordion-item vendedor #}
            </div>   {# end accordion vendedores do EMP #}
          </div>     {# end accordion-item EMP #}

        </div> {# end accordion principal #}

      {% else %}
        <div class="p-4 text-center text-muted">Nenhum resultado para os filtros selecionados.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
