{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h3 class="mb-0">Relatório de Campanhas (Unificado)</h3>
      <div class="text-muted small">Detalhado por <b>EMP → Vendedor → Campanha</b> • Competência {{ "%02d"|format(mes) }}/{{ ano }}</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ export_url }}">Exportar CSV</a>
      <a class="btn btn-primary btn-sm" href="{{ recalc_url }}">Recalcular agora</a>
    </div>
  </div>

  <form method="get" class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-6 col-md-2">
          <label class="form-label">Mês</label>
          <input type="number" class="form-control form-control-sm" name="mes" min="1" max="12" value="{{ mes }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Ano</label>
          <input type="number" class="form-control form-control-sm" name="ano" min="2000" max="2100" value="{{ ano }}">
        </div>

        <div class="col-12 col-md-4">
          <div class="d-flex align-items-center justify-content-between">
            <label class="form-label mb-0">Empresas (EMPs)</label>
            <div class="small">
              <a href="#" data-action="emp_all">todas</a> ·
              <a href="#" data-action="emp_none">nenhuma</a>
            </div>
          </div>
          <input class="form-control form-control-sm mb-2" placeholder="Pesquisar EMP..." id="empSearch">
          <div class="border rounded p-2" style="max-height: 220px; overflow:auto;" id="empBox">
            {% set _emps_sel = emps_sel or [] %}
            {% for opt in (emp_options or []) %}
              <div class="form-check">
                <input class="form-check-input emp-check" type="checkbox" name="emp" value="{{ opt.value }}"
                       id="emp_{{ loop.index }}" {% if opt.value in _emps_sel %}checked{% endif %}>
                <label class="form-check-label" for="emp_{{ loop.index }}">{{ opt.label }}</label>
              </div>
            {% endfor %}
            {% if not (emp_options or []) %}
              <div class="text-muted small">Sem EMPs disponíveis para seleção.</div>
            {% endif %}
          </div>
          <div class="form-text">Selecione uma ou mais EMPs sem usar CTRL (checkbox).</div>
        </div>

        <div class="col-12 col-md-4">
          <div class="d-flex align-items-center justify-content-between">
            <label class="form-label mb-0">Vendedores</label>
            <div class="small">
              <a href="#" data-action="vend_all">todos</a> ·
              <a href="#" data-action="vend_none">nenhum</a>
            </div>
          </div>
          <input class="form-control form-control-sm mb-2" placeholder="Pesquisar vendedor..." id="vendSearch">
          <div class="border rounded p-2" style="max-height: 220px; overflow:auto;" id="vendBox">
            {% set _vsel = vendedores_sel or [] %}
            {% for v in (vendedor_options or []) %}
              <div class="form-check">
                <input class="form-check-input vend-check" type="checkbox" name="vendedor" value="{{ v }}"
                       id="vend_{{ loop.index }}" {% if v in _vsel %}checked{% endif %}>
                <label class="form-check-label" for="vend_{{ loop.index }}">{{ v }}</label>
              </div>
            {% endfor %}
            {% if not (vendedor_options or []) %}
              <div class="text-muted small">Sem vendedores disponíveis para seleção.</div>
            {% endif %}
          </div>
          <div class="form-text">Dica: selecione vendedores após filtrar EMP para reduzir a lista.</div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-success btn-sm" type="submit">Aplicar filtros</button>
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('relatorio_campanhas') }}">Limpar</a>
          <div class="ms-auto d-flex align-items-center gap-2">
            <span class="text-muted small">Por página:</span>
            {% for opt in (per_page_opts or []) %}
              <a class="btn btn-outline-secondary btn-sm {% if per_page==opt %}active{% endif %}" href="{{ per_page_urls[opt] }}">{{ opt }}</a>
            {% endfor %}
          </div>
        </div>
      </div>

      {# manter paginação ao filtrar #}
      <input type="hidden" name="page" value="1">
    </div>
  </form>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Total de linhas</div>
        <div class="fs-4">{{ total_rows or 0 }}</div>
      </div></div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Página</div>
        <div class="fs-4">{{ page }}/{{ total_pages }}</div>
      </div></div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Recompensa (página)</div>
        {% set _sum = 0 %}
        {% for r in (rows_page or []) %}
          {% set _sum = _sum + (r.valor_recompensa or 0) %}
        {% endfor %}
        <div class="fs-4">R$ {{ _sum|brl }}</div>
      </div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead>
            <tr>
              <th>EMP</th>
              <th>Vendedor</th>
              <th>Tipo</th>
              <th>Campanha</th>
              <th class="text-center">Gate</th>
              <th class="text-end">Qtd Base</th>
              <th class="text-end">Qtd Premiada</th>
              <th class="text-end">Valor</th>
              <th>Status</th>
              <th>Pago em</th>
            </tr>
          </thead>
          <tbody>
            {% set last_emp = None %}
            {% set last_v = None %}
            {% for r in (rows_page or [])|sort(attribute='emp') %}
              {% if last_emp != r.emp %}
                <tr class="table-secondary">
                  <td colspan="10"><b>EMP {{ r.emp }}</b></td>
                </tr>
                {% set last_emp = r.emp %}
                {% set last_v = None %}
              {% endif %}

              {% if last_v != r.vendedor %}
                <tr class="table-light">
                  <td></td>
                  <td colspan="9"><b>{{ r.vendedor }}</b></td>
                </tr>
                {% set last_v = r.vendedor %}
              {% endif %}

              <tr>
                <td>{{ r.emp }}</td>
                <td>{{ r.vendedor }}</td>
                <td>{{ r.tipo }}</td>
                <td>{{ r.titulo }}</td>
                <td class="text-center">
                  {% if r.atingiu_gate is not none %}
                    {% if r.atingiu_gate %}<span class="badge bg-success">SIM</span>{% else %}<span class="badge bg-danger">NÃO</span>{% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">{{ r.qtd_base if r.qtd_base is not none else "" }}</td>
                <td class="text-end">{{ r.qtd_premiada if r.qtd_premiada is not none else "" }}</td>
                <td class="text-end">R$ {{ (r.valor_recompensa or 0)|brl }}</td>
                <td>{{ r.status_pagamento or "PENDENTE" }}</td>
                <td>{{ r.pago_em or "" }}</td>
              </tr>
            {% endfor %}
            {% if not (rows_page or []) %}
              <tr><td colspan="10" class="text-muted">Sem dados para os filtros selecionados.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <a class="btn btn-outline-secondary btn-sm" href="{{ prev_url }}">Anterior</a>
        <div class="text-muted small">Página {{ page }} de {{ total_pages }}</div>
        <a class="btn btn-outline-secondary btn-sm" href="{{ next_url }}">Próxima</a>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function filterBox(inputId, boxId){
    const inp = document.getElementById(inputId);
    const box = document.getElementById(boxId);
    if(!inp || !box) return;
    inp.addEventListener('input', function(){
      const q = (inp.value || '').toLowerCase();
      box.querySelectorAll('.form-check').forEach(function(row){
        const txt = (row.innerText || '').toLowerCase();
        row.style.display = txt.includes(q) ? '' : 'none';
      });
    });
  }
  filterBox('empSearch','empBox');
  filterBox('vendSearch','vendBox');

  function setAll(selector, checked){
    document.querySelectorAll(selector).forEach(function(el){ el.checked = checked; });
  }
  document.querySelectorAll('[data-action]').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      const act = a.getAttribute('data-action');
      if(act==='emp_all') setAll('.emp-check', true);
      if(act==='emp_none') setAll('.emp-check', false);
      if(act==='vend_all') setAll('.vend-check', true);
      if(act==='vend_none') setAll('.vend-check', false);
    });
  });
})();
</script>
{% endblock %}
