{% extends "base.html" %}

{% block title %}Relatório de Campanhas — {{ mes }}/{{ ano }}{% endblock %}

{% block extra_head %}
<style>
.table-sm td, .table-sm th { padding: .55rem; }
    .mono { font-variant-numeric: tabular-nums; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="m-0">Relatório de Campanhas</h3>
        <div class="text-muted">Competência: <strong>{{ "%02d"|format(mes) }}/{{ ano }}</strong>
          {% if role %}<span class="badge text-bg-dark ms-2">{{ role|upper }}</span>{% endif %}
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/dashboard">Voltar</a>
        <a class="btn btn-outline-secondary btn-sm" href="/logout">Sair</a>
      </div>
    </div>

    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        {% for cat, msg in msgs %}
          <div class="alert alert-{{ 'warning' if cat == 'warning' else 'info' }} shadow-sm">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <form method="get" action="/relatorios/campanhas" class="row g-2 align-items-end">
          {% if role and role|lower == 'admin' %}
            <div class="col-md-3">
              <label class="form-label">EMP (opcional)</label>
              <input class="form-control" type="text" name="emp" value="{{ emp_param or '' }}" placeholder="ex: 101">
            </div>
            <div class="col-md-4">
              <label class="form-label">Vendedor (opcional)</label>
              <input class="form-control" type="text" name="vendedor" value="{{ request.args.get('vendedor','') }}" placeholder="filtrar um vendedor">
            </div>
          {% endif %}

          <div class="col-auto">
            <label class="form-label">Mês</label>
            <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
          </div>
          <div class="col-auto">
            <label class="form-label">Ano</label>
            <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
          </div>

          <div class="col-auto">
            <button class="btn btn-primary" type="submit">Atualizar</button>
          </div>

          <div class="col text-end">
            <span class="text-muted small">Dica: o relatório é recalculado automaticamente ao abrir.</span>
          </div>
        </form>
      </div>
    </div>

    {% if not emps_data or (emps_data|length) == 0 %}
      <div class="alert alert-warning shadow-sm">
        Nenhum dado encontrado para o período selecionado.
      </div>
    {% else %}
      <div class="accordion" id="accEmps">
        {% for e in emps_data %}
          {% set emp_id = 'emp' ~ loop.index %}
          <div class="accordion-item shadow-sm mb-2">
            <h2 class="accordion-header" id="h{{ emp_id }}">
              <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ emp_id }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="c{{ emp_id }}">
                <div class="w-100 d-flex justify-content-between align-items-center">
                  <div><strong>EMP {{ e.emp }}</strong></div>
                  <div class="mono text-end">
                    Total recompensa: <strong>R$ {{ e.total_emp|brl }}</strong>
                  </div>
                </div>
              </button>
            </h2>
            <div id="c{{ emp_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="h{{ emp_id }}" data-bs-parent="#accEmps">
              <div class="accordion-body">

                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr>
                        <th>Vendedor</th>
                        <th class="text-end">Total recompensa</th>
                        <th class="text-end">Qtd campanhas</th>
                        <th class="text-end">Detalhes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for v in e.vendedores %}
                        {% set vid = emp_id ~ '_v' ~ loop.index %}
                        <tr>
                          <td><strong>{{ v.vendedor }}</strong></td>
                          <td class="text-end mono">R$ {{ v.total_recompensa|brl }}</td>
                          <td class="text-end mono">{{ v.campanhas|length }}</td>
                          <td class="text-end">
                            <button class="btn btn-sm app-action" type="button" data-bs-toggle="collapse" data-bs-target="#d{{ vid }}" aria-expanded="false" aria-controls="d{{ vid }}">
                              Ver campanhas
                            </button>
                          </td>
                        </tr>
                        <tr class="collapse" id="d{{ vid }}">
                          <td colspan="4">
                            {% if not v.campanhas or (v.campanhas|length) == 0 %}
                              <div class="text-muted">Sem campanhas para este vendedor no período.</div>
                            {% else %}
                              <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0">
                                  <thead class="table-light">
                                    <tr>
                                      <th>Título</th>
                                      <th>Produto</th>
                                      <th>Marca</th>
                                      <th class="text-end">Qtd</th>
                                      <th class="text-end">Mín</th>
                                      <th class="text-end">R$/un</th>
                                      <th class="text-end">Recompensa</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for c in v.campanhas %}
                                      <tr>
                                        <td>{{ c.titulo or '' }}</td>
                                        <td class="mono">{{ c.produto_prefixo }}</td>
                                        <td>{{ c.marca }}</td>
                                        <td class="text-end mono">{{ "%.0f"|format(c.qtd_vendida or 0) }}</td>
                                        <td class="text-end mono">
                                          {% if c.qtd_minima is none %}-{% else %}{{ "%.0f"|format(c.qtd_minima) }}{% endif %}
                                        </td>
                                        <td class="text-end mono">R$ {{ (c.recompensa_unit or 0)|brl }}</td>
                                        <td class="text-end mono">
                                          {% if (c.valor_recompensa or 0) > 0 %}
                                            <strong>R$ {{ (c.valor_recompensa or 0)|brl }}</strong>
                                          {% else %}
                                            -
                                          {% endif %}
                                        </td>
                                      </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
