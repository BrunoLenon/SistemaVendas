{% extends "base.html" %}

{% block title %}Relatório Unificado — {{ "%02d"|format(mes) }}/{{ ano }}{% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:800; letter-spacing:-.4px}
  .kpi{border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:14px 16px}
  [data-theme="dark"] .kpi{border-color: rgba(255,255,255,.10)}
  .kpi .label{font-size:.82rem; opacity:.8}
  .kpi .value{font-size:1.35rem; font-weight:800}
  .mono{font-variant-numeric: tabular-nums;}
  .table thead th{white-space:nowrap}
  .badge-soft{background: rgba(13,110,253,.10); color: var(--bs-primary); border:1px solid rgba(13,110,253,.18)}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <div class="page-title h4 mb-1">Relatório Unificado</div>
      <div class="text-secondary">
        Competência <span class="mono">{{ "%02d"|format(mes) }}/{{ ano }}</span>
        {% if recalc %}<span class="badge text-bg-warning ms-2">Recalculado agora</span>{% endif %}
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary btn-sm"
         href="{{ recalc_url }}">
        Recalcular agora
      </a>
      <a class="btn btn-outline-primary btn-sm"
         href="{{ export_url }}">
        Exportar CSV
      </a>
    </div>
  </div>

  <form class="card p-3 mb-3" method="get" action="{{ url_for('relatorio_campanhas') }}">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-md-2">
        <label class="form-label mb-1">Mês</label>
        <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label mb-1">Ano</label>
        <input class="form-control" type="number" name="ano" min="2020" max="2100" value="{{ ano }}">
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label mb-1">EMP (multi)</label>
        <select class="form-select" name="emp" multiple size="3">
          {% for e in emps_scope %}
            <option value="{{ e }}" {% if e in emps_sel %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Dica: segure Ctrl para selecionar mais de uma.</div>
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label mb-1">Vendedor (multi)</label>
        <select class="form-select" name="vendedor" multiple size="3">
          {# Junta vendedores do escopo atual #}
          {% set vset = [] %}
          {% for emp,vlist in vendedores_por_emp.items() %}
            {% for v in vlist %}
              {% if v not in vset %}{% set _ = vset.append(v) %}{% endif %}
            {% endfor %}
          {% endfor %}
          {% for v in vset|sort %}
            <option value="{{ v }}" {% if (vendedores_sel and v in vendedores_sel) %}selected{% endif %}>{{ v }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary">Aplicar filtros</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('relatorio_campanhas') }}">Limpar</a>
      </div>
    </div>
  </form>

  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <div class="kpi">
        <div class="label">Total em recompensas (filtros atuais)</div>
        <div class="value mono">R$ {{ "%.2f"|format(total_recompensa or 0) }}</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi">
        <div class="label">Linhas no relatório</div>
        <div class="value mono">{{ total_rows or 0 }}</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi">
        <div class="label">Página</div>
        <div class="value mono">{{ page }}/{{ total_pages }}</div>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-2">Recompensa por tipo</div>
        <canvas id="chartTipo" height="140"></canvas>
      </div>
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-2">Recompensa por EMP</div>
        <canvas id="chartEmp" height="140"></canvas>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
      <div class="fw-semibold">Tabela consolidada</div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="text-secondary small">por página</label>
        <select class="form-select form-select-sm" style="width:110px"
                onchange="location.href=this.value">
          {% for opt in [200,500,1000] %}
            {% set q = request.args.to_dict() %}
            {% set _ = q.update({'per_page': opt, 'page': 1}) %}
            <option value="{{ per_page_urls[opt] }}" {% if per_page==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>EMP</th>
            <th>Vendedor</th>
            <th>Título</th>
            <th class="text-center">Gate</th>
            <th class="text-end">Qtd/Base</th>
            <th class="text-end">Qtd Premiada</th>
            <th class="text-end">Recompensa</th>
            <th>Status</th>
            <th>Pago em</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows_page %}
            <tr>
              <td><span class="badge badge-soft">{{ r.tipo }}</span></td>
              <td class="mono">{{ r.emp }}</td>
              <td class="mono">{{ r.vendedor }}</td>
              <td>{{ r.titulo }}</td>
              <td class="text-center">
                {% if r.atingiu_gate is none %}
                  <span class="text-secondary">—</span>
                {% elif r.atingiu_gate %}
                  <span class="badge text-bg-success">SIM</span>
                {% else %}
                  <span class="badge text-bg-secondary">NÃO</span>
                {% endif %}
              </td>
              <td class="text-end mono">
                {% if r.qtd_base is none %}—{% else %}{{ "%.2f"|format(r.qtd_base) }}{% endif %}
              </td>
              <td class="text-end mono">
                {% if r.qtd_premiada is none %}—{% else %}{{ "%.2f"|format(r.qtd_premiada) }}{% endif %}
              </td>
              <td class="text-end mono">R$ {{ "%.2f"|format(r.valor_recompensa or 0) }}</td>
              <td><span class="badge text-bg-light">{{ r.status_pagamento }}</span></td>
              <td class="mono">{% if r.pago_em %}{{ r.pago_em }}{% else %}—{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mt-2">
      <div class="text-secondary small">
        Mostrando {{ rows_page|length }} de {{ total_rows }} linhas
      </div>
      <div class="d-flex gap-2">
        {% set qprev = request.args.to_dict() %}
        {% set qnext = request.args.to_dict() %}
        {% set _ = qprev.update({'page': (page-1) if page>1 else 1, 'per_page': per_page}) %}
        {% set _ = qnext.update({'page': (page+1) if page<total_pages else total_pages, 'per_page': per_page}) %}
        <a class="btn btn-outline-secondary btn-sm {% if page<=1 %}disabled{% endif %}" href="{{ prev_url }}">Anterior</a>
        <a class="btn btn-outline-secondary btn-sm {% if page>=total_pages %}disabled{% endif %}" href="{{ next_url }}">Próxima</a>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const charts = {{ charts|tojson }};
  function mkBar(canvasId, items){
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;
    const labels = (items||[]).map(x=>x.label);
    const data = (items||[]).map(x=>x.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'R$', data }] },
      options: {
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }
  mkBar('chartTipo', charts.by_tipo);
  mkBar('chartEmp', charts.by_emp);
})();
</script>
{% endblock %}