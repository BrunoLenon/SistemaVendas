{% extends "base.html" %}
{% from "partials/multiselect.html" import multiselect %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
    <div>
      <h4 class="mb-0">Campanhas — Ranking por Marca</h4>
      <small class="text-muted">Cadastro (Admin) + Snapshot (resultados congelados por mês/ano)</small>
    </div>
    <div class="d-flex flex-wrap gap-2">
      {# No seu app, o endpoint "campanhas" não existe; o mais próximo é "campanhas_qtd" #}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('campanhas_qtd') }}">Campanhas</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('relatorio_campanhas') }}">Relatório de Campanhas</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>
  </div>

  {% if flash_messages %}
    {% for c, m in flash_messages %}
      <div class="alert alert-{{ c }} py-2">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <div class="card mb-3">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <strong>Nova campanha (Ranking por Marca)</strong>
      <span class="text-muted small">Tipo: <code>RANKING_MARCA</code></span>
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('admin_campanhas_ranking_marca') }}">
        <input type="hidden" name="action" value="create">

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Nome</label>
            <input class="form-control" name="nome" required placeholder="Ex: Ranking Magnetron Fevereiro">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Marca (alvo)</label>
            <input class="form-control" name="marca_alvo" required placeholder="Ex: MAGNETRON">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Escopo</label>
            <select class="form-select" name="scope_mode">
              <option value="GLOBAL">GLOBAL (todas EMPs)</option>
              <option value="POR_EMP">POR_EMP (selecionar EMPs)</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Mínimo (R$)</label>
            <input class="form-control" type="number" step="0.01" name="base_minima_valor" value="10000">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Prêmio 1º (R$)</label>
            <input class="form-control" type="number" step="0.01" name="premio_top1" value="300">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Prêmio 2º (R$)</label>
            <input class="form-control" type="number" step="0.01" name="premio_top2" value="200">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Prêmio 3º (R$)</label>
            <input class="form-control" type="number" step="0.01" name="premio_top3" value="100">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Vigência início</label>
            <input class="form-control" type="date" name="vigencia_inicio">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Vigência fim</label>
            <input class="form-control" type="date" name="vigencia_fim">
          </div>

          <div class="col-12">
            <label class="form-label">EMPs do escopo (apenas se POR_EMP)</label>
            {{ multiselect("scope_emps", emps_options or [], selected_scope_emps or [], placeholder="Selecione uma ou mais EMPs") }}
            <div class="form-text">Admin sempre vê tudo. Supervisor/Vendedor só enxergam campanhas POR_EMP se estiverem nessas EMPs.</div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary">Criar campanha</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <strong>Campanhas cadastradas</strong>
      <form class="d-flex gap-2" method="get" action="{{ url_for('admin_campanhas_ranking_marca') }}">
        <select class="form-select form-select-sm" name="ano" style="width: 110px;">
          {% for y in anos %}
            <option value="{{ y }}" {% if y == ano_selected %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <select class="form-select form-select-sm" name="mes" style="width: 110px;">
          {% for m in meses %}
            <option value="{{ m }}" {% if m == mes_selected %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-outline-secondary btn-sm">Competência</button>
      </form>
    </div>
    <div class="card-body">
      {% if campanhas %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Marca</th>
              <th>Escopo</th>
              <th>Mínimo</th>
              <th>Prêmios</th>
              <th>Vigência</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for c in campanhas %}
            <tr>
              <td>{{ c.id }}</td>
              <td>{{ c.nome }}</td>
              <td><code>{{ c.marca_alvo }}</code></td>
              <td>{{ c.scope_mode }}</td>
              <td>R$ {{ "%.2f"|format(c.base_minima_valor or 0) }}</td>
              <td>
                1º R$ {{ "%.2f"|format(c.premio_top1 or 0) }} /
                2º R$ {{ "%.2f"|format(c.premio_top2 or 0) }} /
                3º R$ {{ "%.2f"|format(c.premio_top3 or 0) }}
              </td>
              <td>
                {{ c.vigencia_inicio or "-" }} → {{ c.vigencia_fim or "-" }}
              </td>
              <td class="text-end">
                <form method="post" action="{{ url_for('admin_campanhas_ranking_marca') }}" class="d-inline">
                  <input type="hidden" name="action" value="recalcular">
                  <input type="hidden" name="campanha_id" value="{{ c.id }}">
                  <input type="hidden" name="ano" value="{{ ano_selected }}">
                  <input type="hidden" name="mes" value="{{ mes_selected }}">
                  <button class="btn btn-sm btn-outline-primary">Recalcular {{ mes_selected }}/{{ ano_selected }}</button>
                </form>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('campanhas_ranking_marca', campanha_id=c.id, ano=ano_selected, mes=mes_selected) }}">Ver ranking</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">Nenhuma campanha cadastrada ainda.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
