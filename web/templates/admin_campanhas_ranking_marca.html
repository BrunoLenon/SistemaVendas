{% extends "base.html" %}
{% from "partials/multiselect.html" import multiselect %}

{% block title %}Admin ‚Äî Ranking por Marca{% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:800; letter-spacing:-.3px}
  .subtitle{color:var(--bs-secondary-color)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h3 class="m-0 page-title">üèÅ Campanhas ‚Äî Ranking por Marca</h3>
      <div class="subtitle mt-1">Configura√ß√£o + snapshot por compet√™ncia. Premia√ß√£o fixa (1¬∫/2¬∫/3¬∫).</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_fechamento') }}">Fechamento</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('financeiro_campanhas_v2') }}">Financeiro</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('relatorios_campanhas') }}">Relat√≥rio de Campanhas</a>
    </div>
  </div>

  {% if erro %}<div class="alert alert-danger">{{ erro }}</div>{% endif %}
  {% if ok %}<div class="alert alert-success">{{ ok }}</div>{% endif %}

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="m-0">Criar campanha</h5>
      <div class="subtitle small mt-1">Dica: se n√£o preencher pr√™mios, o default √© 1=300, 2=200, 3=100.</div>

      <form method="post" class="mt-3">
        <input type="hidden" name="acao" value="criar">

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nome</label>
            <input class="form-control" name="nome" placeholder="Ranking MAGNETRON ‚Äî Fevereiro" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marca</label>
            <input class="form-control mono" name="marca_alvo" placeholder="MAGNETRON" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Escopo</label>
            <select class="form-select" name="scope_mode">
              <option value="GLOBAL" selected>GLOBAL (todas as EMPs)</option>
              <option value="POR_EMP">POR EMP (selecionar EMPs)</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Vig√™ncia in√≠cio</label>
            <input class="form-control" type="date" name="vigencia_inicio">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vig√™ncia fim</label>
            <input class="form-control" type="date" name="vigencia_fim">
          </div>

          <div class="col-md-3">
            <label class="form-label">M√≠nimo (R$)</label>
            <input class="form-control mono" name="base_minima_valor" placeholder="10000">
          </div>
          <div class="col-md-3">
            <label class="form-label">Ativa?</label>
            <select class="form-select" name="ativo">
              <option value="1" selected>Sim</option>
              <option value="0">N√£o</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label">EMPs (se POR_EMP)</label>
            {{ multiselect("emps", emps_opts, [], placeholder="Selecione EMPs...") }}
            <div class="form-text">Somente usu√°rios vinculados √†s EMPs selecionadas ir√£o visualizar esta campanha (exceto ADMIN).</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Pr√™mio 1¬∫ (R$)</label>
            <input class="form-control mono" name="premio_top1" placeholder="300">
          </div>
          <div class="col-md-4">
            <label class="form-label">Pr√™mio 2¬∫ (R$)</label>
            <input class="form-control mono" name="premio_top2" placeholder="200">
          </div>
          <div class="col-md-4">
            <label class="form-label">Pr√™mio 3¬∫ (R$)</label>
            <input class="form-control mono" name="premio_top3" placeholder="100">
          </div>

        </div>

        <div class="mt-3 d-flex justify-content-end">
          <button class="btn btn-primary" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <h5 class="m-0">Campanhas cadastradas</h5>
          <div class="subtitle small mt-1">Recalcule para gerar snapshot do m√™s e alimentar Financeiro.</div>
        </div>

        <form class="d-flex gap-2" method="get">
          <select class="form-select form-select-sm" name="mes" style="max-width:120px">
            {% for m in range(1,13) %}
              <option value="{{ m }}" {% if m==mes|int %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
            {% endfor %}
          </select>
          <select class="form-select form-select-sm" name="ano" style="max-width:120px">
            {% for a in anos %}
              <option value="{{ a }}" {% if a==ano|int %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-secondary btn-sm" type="submit">Compet√™ncia</button>
        </form>
      </div>

      {% if not campanhas %}
        <div class="text-muted mt-3">Nenhuma campanha de ranking por marca cadastrada ainda.</div>
      {% else %}
        <div class="accordion mt-3" id="accRankMarca">
          {% for c in campanhas %}
            {% set cid = c.id %}
            {% set emps = (emps_map.get(cid) or []) %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="h{{ cid }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ cid }}" aria-expanded="false" aria-controls="c{{ cid }}">
                  <b class="me-2">#{{ cid }}</b> {{ c.nome }} ‚Äî <span class="mono ms-2">{{ c.marca_alvo }}</span>
                  {% if not c.ativo %}<span class="badge text-bg-secondary ms-2">INATIVA</span>{% endif %}
                  <span class="badge text-bg-info ms-2">{{ (c.scope_mode or 'GLOBAL')|upper }}</span>
                </button>
              </h2>
              <div id="c{{ cid }}" class="accordion-collapse collapse" aria-labelledby="h{{ cid }}" data-bs-parent="#accRankMarca">
                <div class="accordion-body">

                  <div class="row g-2">
                    <div class="col-md-6">
                      <div class="small text-muted">Vig√™ncia</div>
                      <div>{{ c.vigencia_inicio or '‚Äî' }} ‚Üí {{ c.vigencia_fim or '‚Äî' }}</div>

                      <div class="small text-muted mt-2">M√≠nimo</div>
                      <div class="mono">R$ {{ "%.2f"|format(c.base_minima_valor or 0) }}</div>
                    </div>
                    <div class="col-md-6">
                      <div class="small text-muted">EMPs (escopo)</div>
                      {% if (c.scope_mode or '').upper() == 'POR_EMP' %}
                        <div class="mono">{{ emps|join(', ') if emps else '‚Äî' }}</div>
                      {% else %}
                        <div>GLOBAL (todas)</div>
                      {% endif %}
                      <div class="small text-muted mt-2">Pr√™mios</div>
                      <div class="mono">
                        1={{ "%.2f"|format(c.premio_top1 or 0) }},
                        2={{ "%.2f"|format(c.premio_top2 or 0) }},
                        3={{ "%.2f"|format(c.premio_top3 or 0) }}
                      </div>
                    </div>
                  </div>

                  <hr>

                  <div class="row g-3">
                    <div class="col-lg-8">
                      <form method="post" class="border rounded p-3">
                        <input type="hidden" name="acao" value="editar">
                        <input type="hidden" name="id" value="{{ cid }}">

                        <div class="row g-2">
                          <div class="col-12">
                            <label class="form-label">Nome</label>
                            <input class="form-control" name="nome" value="{{ c.nome }}" required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Marca</label>
                            <input class="form-control mono" name="marca_alvo" value="{{ c.marca_alvo }}" required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Escopo</label>
                            <select class="form-select" name="scope_mode">
                              <option value="GLOBAL" {% if (c.scope_mode or '').upper() == 'GLOBAL' %}selected{% endif %}>GLOBAL</option>
                              <option value="POR_EMP" {% if (c.scope_mode or '').upper() == 'POR_EMP' %}selected{% endif %}>POR_EMP</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Ativa?</label>
                            <select class="form-select" name="ativo">
                              <option value="1" {% if c.ativo %}selected{% endif %}>Sim</option>
                              <option value="0" {% if not c.ativo %}selected{% endif %}>N√£o</option>
                            </select>
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Vig√™ncia in√≠cio</label>
                            <input class="form-control" type="date" name="vigencia_inicio" value="{{ c.vigencia_inicio }}">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Vig√™ncia fim</label>
                            <input class="form-control" type="date" name="vigencia_fim" value="{{ c.vigencia_fim }}">
                          </div>

                          <div class="col-md-4">
                            <label class="form-label">M√≠nimo (R$)</label>
                            <input class="form-control mono" name="base_minima_valor" value="{{ c.base_minima_valor or '' }}">
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Pr√™mio 1¬∫</label>
                            <input class="form-control mono" name="premio_top1" value="{{ c.premio_top1 or '' }}">
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Pr√™mio 2¬∫</label>
                            <input class="form-control mono" name="premio_top2" value="{{ c.premio_top2 or '' }}">
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Pr√™mio 3¬∫</label>
                            <input class="form-control mono" name="premio_top3" value="{{ c.premio_top3 or '' }}">
                          </div>

                          <div class="col-12">
                            <label class="form-label">EMPs (se POR_EMP)</label>
                            {{ multiselect("emps", emps_opts, emps, placeholder="Selecione EMPs...") }}
                          </div>
                        </div>

                        <div class="mt-3 d-flex justify-content-end">
                          <button class="btn btn-primary" type="submit">Salvar altera√ß√µes</button>
                        </div>
                      </form>
                    </div>

                    <div class="col-lg-4">
                      <div class="border rounded p-3">
                        <div class="fw-semibold">A√ß√µes</div>
                        <div class="text-muted small mt-1">A compet√™ncia usada aqui √©: <b>{{ "%02d"|format(mes|int) }}/{{ ano }}</b></div>

                        <form method="post" class="mt-3">
                          <input type="hidden" name="acao" value="recalcular">
                          <input type="hidden" name="id" value="{{ cid }}">
                          <input type="hidden" name="ano" value="{{ ano }}">
                          <input type="hidden" name="mes" value="{{ mes }}">
                          <button class="btn btn-outline-primary w-100" type="submit">Recalcular e gerar snapshot</button>
                        </form>

                        <form method="post" class="mt-2" onsubmit="return confirm('Remover a campanha #{{ cid }}? Isso tamb√©m remove resultados e pagamentos vinculados.');">
                          <input type="hidden" name="acao" value="remover">
                          <input type="hidden" name="id" value="{{ cid }}">
                          <button class="btn btn-outline-danger w-100" type="submit">Remover campanha</button>
                        </form>

                        <div class="text-muted small mt-3">
                          Depois de recalcular, o ranking fica vis√≠vel em <b>/campanhas/ranking-marca</b>
                          e o pr√™mio entra em <b>Financeiro</b> para Fechamento/Pagamento.
                        </div>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
