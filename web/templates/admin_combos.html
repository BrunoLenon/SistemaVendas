{% extends "base.html" %}
{% block title %}Admin ‚Äî Combos (Kit){% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 1200px;">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h3 class="m-0">üß© Combos (Kit)</h3>
      <div class="text-muted">Paga por unidade <b>ap√≥s</b> bater o m√≠nimo em <b>todos</b> os itens do kit (marca obrigat√≥ria).</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="badge text-bg-light border text-dark">Compet√™ncia: {{ mes }}/{{ ano }}</span>
      <a class="btn btn-outline-secondary btn-sm" href="/dashboard">‚Üê Voltar</a>
    </div>
  </div>

  {% if erro %}
    <div class="alert alert-danger">{{ erro }}</div>
  {% endif %}
  {% if ok %}
    <div class="alert alert-success">{{ ok }}</div>
  {% endif %}

  <div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold">Novo Combo</div>
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#dicasCombo" aria-expanded="false">
        üí° Dicas
      </button>
    </div>
    <div class="collapse" id="dicasCombo">
      <div class="card-body border-bottom">
        <div class="small text-muted">
          <ul class="mb-0">
            <li><b>Marca</b> √© obrigat√≥ria e filtra as vendas do per√≠odo do combo.</li>
            <li><b>Gate</b>: o vendedor precisa bater o <b>m√≠nimo em todos os itens</b> para o combo ‚Äúatingir‚Äù.</li>
            <li>Itens podem ser por <b>Mestre (prefixo)</b> e/ou por <b>Descri√ß√£o cont√©m</b> (ex.: ‚ÄúMOTOR PARTIDA‚Äù).</li>
            <li><b>R$/un</b> no item √© opcional. Se vazio, usa o <b>Valor unit√°rio global</b> do combo (se informado).</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card-body">
      <form method="post" action="/admin/combos" class="vstack gap-3">
        <input type="hidden" name="acao" value="criar"/>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">T√≠tulo <span class="text-danger">*</span></label>
            <input class="form-control" name="titulo" placeholder="Ex: Combo Magnetron Fevereiro" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">EMP (opcional)</label>
            <input class="form-control" name="emp" placeholder="Ex: 1001">
            <div class="form-text">Vazio = combo global (todas as EMPs).</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marca <span class="text-danger">*</span></label>
            <input class="form-control" name="marca" placeholder="Ex: MAGNETRON" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Valor unit√°rio global (opcional)</label>
            <input class="form-control" name="valor_unitario_global" inputmode="decimal" placeholder="Ex: 2,00">
          </div>
          <div class="col-md-3">
            <label class="form-label">Filtro marca (modelo 2)</label>
            <input class="form-control" name="filtro_marca" placeholder="Ex: MAGNETRON">
            <div class="form-text">Opcional: restringe ainda mais a marca.</div>
          </div>
          <div class="col-md-5">
            <label class="form-label">Descri√ß√£o come√ßa com (modelo 2)</label>
            <input class="form-control" name="descricao_comeca" placeholder="Ex: MOTOR DE PARTIDA">
          </div>
          <div class="col-md-4">
            <label class="form-label">Valor unit√°rio modelo 2 (opcional)</label>
            <input class="form-control" name="valor_unitario_modelo2" inputmode="decimal" placeholder="Ex: 1,00">
          </div>
          <div class="col-md-3">
            <label class="form-label">Data in√≠cio <span class="text-danger">*</span></label>
            <input class="form-control" type="date" name="data_inicio" value="{{ default_data_inicio }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Data fim <span class="text-danger">*</span></label>
            <input class="form-control" type="date" name="data_fim" value="{{ default_data_fim }}" required>
          </div>
        </div>

        <hr class="my-2"/>

        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Requisitos (itens do kit)</div>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="addLine()">+ Adicionar linha</button>
        </div>
        <div class="small text-muted">Preencha <b>Mestre</b> e/ou <b>Descri√ß√£o cont√©m</b>. ‚ÄúM√≠nimo‚Äù √© obrigat√≥rio.</div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="itensTable">
            <thead>
              <tr>
                <th style="width: 20%;">Mestre (prefixo)</th>
                <th>Descri√ß√£o cont√©m</th>
                <th style="width: 10%;">M√≠nimo <span class="text-danger">*</span></th>
                <th style="width: 14%;">R$/un (opcional)</th>
                <th style="width: 1%;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
                <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
                <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="1" required></td>
                <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="Ex: 2,00"></td>
                <td><button class="btn btn-outline-danger btn-sm" type="button" onclick="removeLine(this)">‚úï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-success">Salvar Combo</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header fw-semibold">Combos cadastrados (intersectam {{ mes }}/{{ ano }})</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle m-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>T√≠tulo</th>
              <th>EMP</th>
              <th>Marca</th>
              <th>Vig√™ncia</th>
              <th class="text-end">Valor global</th>
              <th>Itens do kit</th>
            </tr>
          </thead>
          <tbody>
            {% for c in (combos or []) %}
            {% set cid = c.id %}
            <tr>
              <td class="text-muted">{{ c.id }}</td>
              <td class="fw-semibold">{{ c.titulo }}</td>
              <td>{{ c.emp or "‚Äî" }}</td>
              <td>{{ c.marca }}</td>
              <td class="text-muted">{{ c.data_inicio }} ‚Üí {{ c.data_fim }}</td>
              <td class="text-end">{{ '%.2f'|format(c.valor_unitario_global or 0) if c.valor_unitario_global else "‚Äî" }}</td>
              <td>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#kit{{ cid }}">
                  Ver itens ({{ (combos_itens_map.get(cid) or [])|length }})
                </button>
              </td>
            </tr>
            <tr class="collapse" id="kit{{ cid }}">
              <td colspan="7" class="bg-light">
                {% set itens = combos_itens_map.get(cid) or [] %}
                {% if not itens %}
                  <div class="text-muted small">Nenhum item cadastrado.</div>
                {% else %}
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Regra</th>
                          <th class="text-end">M√≠nimo</th>
                          <th class="text-end">R$/un</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for it in itens %}
                        <tr>
                          <td class="text-muted">{{ it.ordem }}</td>
                          <td class="small">
                            {% if it.mestre_prefixo %}
                              <span class="badge text-bg-light border text-dark me-1">Mestre</span>{{ it.mestre_prefixo }}
                            {% endif %}
                            {% if it.descricao_contains %}
                              <span class="badge text-bg-light border text-dark ms-2 me-1">Descri√ß√£o</span>{{ it.descricao_contains }}
                            {% endif %}
                            {% if not it.mestre_prefixo and not it.descricao_contains %}
                              {{ it.match_mestre }}
                            {% endif %}
                          </td>
                          <td class="text-end">{{ '%.0f'|format(it.minimo_qtd or 0) }}</td>
                          <td class="text-end">
                            {% if it.valor_unitario is not none %}
                              {{ '%.2f'|format(it.valor_unitario) }}
                            {% else %}
                              <span class="text-muted">global</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function addLine(){
  const tbody = document.querySelector("#itensTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
    <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
    <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="1" required></td>
    <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="Ex: 2,00"></td>
    <td><button class="btn btn-outline-danger btn-sm" type="button" onclick="removeLine(this)">‚úï</button></td>
  `;
  tbody.appendChild(tr);
}
function removeLine(btn){
  const tr = btn.closest("tr");
  if(!tr) return;
  const tbody = tr.parentElement;
  if(tbody.querySelectorAll("tr").length <= 1) return; // mant√©m ao menos 1
  tr.remove();
}
</script>
{% endblock %}
