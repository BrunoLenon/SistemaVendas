{% extends "base.html" %}

{% block title %}Admin ‚Äî Combos (Kit){% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:700; letter-spacing:-.3px}
  .subtitle{color:var(--bs-secondary-color)}
  .kpi{display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .65rem; border-radius:999px; background:rgba(13,110,253,.08); color:#0d6efd; font-size:.85rem}
  .card-soft{border-radius:1rem}
  .form-control, .form-select{border-radius:.75rem}
  .table td, .table th{vertical-align:middle}
  .hint{color:var(--bs-secondary-color); font-size:.85rem}
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 1200px;">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <h3 class="m-0 page-title">üß© Combos (Kit)</h3>
        <span class="kpi">Per√≠odo: {{ "%02d"|format(mes|int) }}/{{ ano }}</span>
      </div>
      <div class="subtitle">Campanha por unidade ap√≥s bater o m√≠nimo em <b>TODOS</b> os itens (marca obrigat√≥ria).</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-end">
      <a class="btn btn-sm btn-outline-secondary" href="/dashboard">‚Üê Voltar</a>
      <form class="d-flex gap-2 align-items-end" method="get" action="/admin/combos">
        <div>
          <label class="form-label mb-1">M√™s</label>
          <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" style="width:90px;">
        </div>
        <div>
          <label class="form-label mb-1">Ano</label>
          <input class="form-control" type="number" name="ano" min="2020" max="2035" value="{{ ano }}" style="width:110px;">
        </div>
        <button class="btn btn-primary" type="submit">Carregar</button>
      </form>
    </div>
  </div>


  {% if erro %}
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Novo Combo</strong>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#comboTipsCollapse" aria-expanded="false">Dicas</button>
    </div>
  {% endif %}
      <div class="collapse mb-3" id="comboTipsCollapse">
        <div class="alert alert-light border small mb-0">
          <div class="fw-semibold mb-1">Como configurar corretamente</div>
          <ul class="mb-0">
            <li><b>EMP</b> vazio = combo v√°lido para <b>todas</b> as empresas. Preencha para restringir (ex.: <code>101</code>).</li>
            <li><b>Itens do combo</b>: cada item precisa de <b>Mestre prefixo</b> <i>ou</i> <b>Descri√ß√£o cont√©m</b> (um dos dois) + <b>m√≠nimo</b>.</li>
            <li><b>Ordem</b> define a sequ√™ncia dos itens no kit (1, 2, 3...).</li>
            <li><b>match_mestre</b> √© preenchido automaticamente (mestre_prefixo ‚Üí descri√ß√£o_contains ‚Üí nome_item). Ele √© <b>obrigat√≥rio</b>.</li>
          </ul>
          <div class="hint mt-2">Dica: use <b>Mestre prefixo</b> quando o c√≥digo do produto √© padronizado; use <b>Descri√ß√£o cont√©m</b> para capturar marca/linha (ex.: <code>BOSCH</code>).</div>
        </div>
      </div>
  {% if ok %}
    <div class="alert alert-success shadow-sm">{{ ok }}</div>
  {% endif %}

  <div class="card card-soft shadow-sm mb-3">
    <div class="card-header"><strong>Novo Combo</strong></div>
    <div class="card-body">
      <form method="post" action="/admin/combos?mes={{ mes }}&ano={{ ano }}" id="form-combo">
        <input type="hidden" name="acao" value="criar">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">T√≠tulo</label>
            <input class="form-control" name="titulo" required placeholder="Ex: Linha el√©trica BOSCH">
          </div>
          <div class="col-md-2">
            <label class="form-label">EMP (opcional)</label>
            <input class="form-control" name="emp" placeholder="101">
            <div class="form-text">Vazio = global.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marca (obrigat√≥ria)</label>
            <input class="form-control" name="marca" required placeholder="BOSCH">
          </div>
          <div class="col-md-3">
            <label class="form-label">Valor unit√°rio global (opcional)</label>
            <input class="form-control" name="valor_unitario_global" inputmode="decimal" placeholder="2.00">
          </div>

          <div class="col-md-3">
            <label class="form-label">Modelo de pagamento</label>
            <select class="form-select" name="modelo_pagamento">
              <option value="TODOS_ITENS" selected>Combo ‚Äî pagar por todos itens do gate</option>
              <option value="POR_DESCRICAO">Combo ‚Äî pagar por descri√ß√£o+marca (ap√≥s gate)</option>
            </select>
            <div class="form-text">No modelo 2, o vendedor precisa bater o gate e depois recebe por unidade filtrada.</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Filtro marca (modelo 2)</label>
            <input class="form-control" name="filtro_marca" placeholder="MAGNETRON">
          </div>

          <div class="col-md-3">
            <label class="form-label">Descri√ß√£o come√ßa com (modelo 2)</label>
            <input class="form-control" name="filtro_descricao_prefixo" placeholder="MOTOR DE PARTIDA">
          </div>

          <div class="col-md-3">
            <label class="form-label">Valor unit√°rio modelo 2 (opcional)</label>
            <input class="form-control" name="valor_unitario_modelo2" inputmode="decimal" placeholder="1.00">
          </div>

          <div class="col-md-3">
            <label class="form-label">Data in√≠cio</label>
            <input class="form-control" type="date" name="data_inicio" value="{{ default_data_inicio }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Data fim</label>
            <input class="form-control" type="date" name="data_fim" value="{{ default_data_fim }}">
          </div>
        </div>

        <hr class="my-3">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Requisitos (itens do kit)</div>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-add-linha">+ Adicionar linha</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="tbl-itens">
            <thead>
              <tr>
                <th scope="col">MESTRE (prefixo)</th>
                <th scope="col">DESCRI√á√ÉO cont√©m</th>
                <th scope="col" style="width:120px;">M√≠nimo</th>
                <th scope="col" style="width:140px;">R$/un (opcional)</th>
                <th scope="col" style="width:60px;"></th>
            <th class="text-end">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
                <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
                <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="5"></td>
                <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="2.00"></td>
                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-del">‚úï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-success" type="submit">Salvar Combo</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card card-soft shadow-sm">
    <div class="card-header"><strong>Combos cadastrados (intersectam {{ mes }}/{{ ano }})</strong></div>
    <div class="card-body">
      {% if not combos or (combos|length)==0 %}
        <div class="text-muted">Nenhum combo cadastrado para o per√≠odo.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">T√≠tulo</th>
                <th scope="col">EMP</th>
                <th scope="col">Marca</th>
                <th scope="col">Vig√™ncia</th>
                <th scope="col">Valor global</th>
              </tr>
            </thead>
            <tbody>
              {% for c in combos %}
                <tr>
                  <td class="text-muted">{{ c.id }}</td>
                  <td>{{ c.titulo }}</td>
                  <td>{{ c.emp or 'GLOBAL' }}</td>
                  <td>{{ c.marca }}</td>
                  <td>{{ c.data_inicio }} ‚Üí {{ c.data_fim }}</td>
                  <td>{% if c.valor_unitario_global is not none %}{{ '%.2f'|format(c.valor_unitario_global) }}{% else %}-{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const tbl = document.getElementById('tbl-itens');
  const btnAdd = document.getElementById('btn-add-linha');
  if(!tbl || !btnAdd) return;

  function wireRow(tr){
    const del = tr.querySelector('.btn-del');
    if(del){
      del.addEventListener('click', () => {
        const tbody = tbl.querySelector('tbody');
        if(tbody.querySelectorAll('tr').length > 1){
          tr.remove();
        }else{
          // limpa
          tr.querySelectorAll('input').forEach(i => i.value = '');
        }
      });
    }
  }

  tbl.querySelectorAll('tbody tr').forEach(wireRow);

  btnAdd.addEventListener('click', () => {
    const tbody = tbl.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
      <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
      <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="5"></td>
      <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="2.00"></td>
      <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-del">‚úï</button></td>
    `;
    tbody.appendChild(tr);
    wireRow(tr);
  });
})();
</script>
{% endblock %}