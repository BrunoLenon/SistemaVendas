{% extends "base.html" %}
{% block title %}Admin ‚Äî Combos (Kit){% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 1200px;">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h3 class="m-0">üß© Combos (Kit)</h3>
      <div class="text-muted">Campanha por unidade ap√≥s bater o m√≠nimo em TODOS os itens (marca obrigat√≥ria).</div>
    </div>
    <form class="d-flex gap-2 align-items-end" method="get" action="/admin/combos">
      <div>
        <label class="form-label mb-1">M√™s</label>
        <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" style="width:90px;">
      </div>
      <div>
        <label class="form-label mb-1">Ano</label>
        <input class="form-control" type="number" name="ano" min="2020" max="2035" value="{{ ano }}" style="width:110px;">
      </div>
      <button class="btn btn-primary" type="submit">Carregar</button>
    </form>
  </div>

  {% if erro %}
    <div class="alert alert-danger shadow-sm">{{ erro }}</div>
  {% endif %}
  {% if ok %}
    <div class="alert alert-success shadow-sm">{{ ok }}</div>
  {% endif %}

  <div class="card shadow-sm mb-3">
    <div class="card-header"><strong>Novo Combo</strong></div>
    <div class="card-body">
      <form method="post" action="/admin/combos?mes={{ mes }}&ano={{ ano }}" id="form-combo">
        <input type="hidden" name="acao" value="criar">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">T√≠tulo</label>
            <input class="form-control" name="titulo" required placeholder="Ex: Linha el√©trica BOSCH">
          </div>
          <div class="col-md-2">
            <label class="form-label">EMP (opcional)</label>
            <input class="form-control" name="emp" placeholder="101">
            <div class="form-text">Vazio = global.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Marca (obrigat√≥ria)</label>
            <input class="form-control" name="marca" required placeholder="BOSCH">
          </div>
          <div class="col-md-3">
            <label class="form-label">Valor unit√°rio global (opcional)</label>
            <input class="form-control" name="valor_unitario_global" inputmode="decimal" placeholder="2.00">
          </div>

          <div class="col-md-3">
            <label class="form-label">Data in√≠cio</label>
            <input class="form-control" type="date" name="data_inicio" value="{{ default_data_inicio }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Data fim</label>
            <input class="form-control" type="date" name="data_fim" value="{{ default_data_fim }}">
          </div>
        </div>

        <hr class="my-3">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Requisitos (itens do kit)</div>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-add-linha">+ Adicionar linha</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="tbl-itens">
            <thead>
              <tr>
                <th scope="col">MESTRE (prefixo)</th>
                <th scope="col">DESCRI√á√ÉO cont√©m</th>
                <th scope="col" style="width:120px;">M√≠nimo</th>
                <th scope="col" style="width:140px;">R$/un (opcional)</th>
                <th scope="col" style="width:60px;"></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
                <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
                <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="5"></td>
                <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="2.00"></td>
                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-del">‚úï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-success" type="submit">Salvar Combo</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header"><strong>Combos cadastrados (intersectam {{ mes }}/{{ ano }})</strong></div>
    <div class="card-body">
      {% if not combos or (combos|length)==0 %}
        <div class="text-muted">Nenhum combo cadastrado para o per√≠odo.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">T√≠tulo</th>
                <th scope="col">EMP</th>
                <th scope="col">Marca</th>
                <th scope="col">Vig√™ncia</th>
                <th scope="col">Valor global</th>
              </tr>
            </thead>
            <tbody>
              {% for c in combos %}
                <tr>
                  <td class="text-muted">{{ c.id }}</td>
                  <td>{{ c.titulo }}</td>
                  <td>{{ c.emp or 'GLOBAL' }}</td>
                  <td>{{ c.marca }}</td>
                  <td>{{ c.data_inicio }} ‚Üí {{ c.data_fim }}</td>
                  <td>{% if c.valor_unitario_global is not none %}{{ '%.2f'|format(c.valor_unitario_global) }}{% else %}-{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const tbl = document.getElementById('tbl-itens');
  const btnAdd = document.getElementById('btn-add-linha');
  if(!tbl || !btnAdd) return;

  function wireRow(tr){
    const del = tr.querySelector('.btn-del');
    if(del){
      del.addEventListener('click', () => {
        const tbody = tbl.querySelector('tbody');
        if(tbody.querySelectorAll('tr').length > 1){
          tr.remove();
        }else{
          // limpa
          tr.querySelectorAll('input').forEach(i => i.value = '');
        }
      });
    }
  }

  tbl.querySelectorAll('tbody tr').forEach(wireRow);

  btnAdd.addEventListener('click', () => {
    const tbody = tbl.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="form-control" name="mestre_prefixo[]" placeholder="Ex: 1234"></td>
      <td><input class="form-control" name="descricao_contains[]" placeholder="Ex: MOTOR PARTIDA"></td>
      <td><input class="form-control" name="minimo_qtd[]" type="number" min="0" step="1" value="5"></td>
      <td><input class="form-control" name="valor_unitario[]" inputmode="decimal" placeholder="2.00"></td>
      <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-del">‚úï</button></td>
    `;
    tbody.appendChild(tr);
    wireRow(tr);
  });
})();
</script>
{% endblock %}
