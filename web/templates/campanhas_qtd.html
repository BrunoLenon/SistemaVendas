{% extends "base.html" %}
{% block title %}Campanhas (Qtd){% endblock %}

{% block content %}
<div class="sv-page">
  <div class="sv-panel sv-panel--hero">
    <div class="sv-hero">
      <div>
        <div class="sv-breadcrumb">Campanhas</div>
        <div class="sv-title">Campanhas do mês (Qtd)</div>
        <div class="sv-muted">Filtre por EMP e vendedor. A lista agrupa por vendedor e permite ver as campanhas dentro de cada um.</div>
      </div>

      <div class="sv-actions">
        <a class="sv-btn sv-btn--ghost" href="{{ url_for('campanhas_qtd') }}">Atualizar</a>
      </div>
    </div>
  </div>

  <form method="get" class="sv-panel">
    <div class="sv-grid sv-grid--3">
      <div class="sv-field">
        <label>Mês</label>
        <input class="sv-input" type="number" name="mes" min="1" max="12" value="{{ mes|default('') }}" />
      </div>
      <div class="sv-field">
        <label>Ano</label>
        <input class="sv-input" type="number" name="ano" min="2000" max="2100" value="{{ ano|default('') }}" />
      </div>
      <div class="sv-field">
        <label>Visão</label>
        <select class="sv-select" name="visao">
          <option value="detalhado" {% if visao=='detalhado' %}selected{% endif %}>Detalhado</option>
          <option value="resumo" {% if visao=='resumo' %}selected{% endif %}>Resumo</option>
        </select>
      </div>
    </div>

    <div class="sv-grid sv-grid--2 sv-mt-3">
      <div class="sv-card">
        <div class="sv-card__header">
          <div>
            <div class="sv-card__title">EMP</div>
            <div class="sv-muted">Selecione uma ou mais</div>
          </div>
          <button type="button" class="sv-btn sv-btn--sm sv-btn--ghost" data-sv-checkall="emp">Marcar todas</button>
        </div>
        <div class="sv-card__body sv-scrollbox">
          {% for emp in emp_options %}
            <label class="sv-check">
              <input type="checkbox" name="emp" value="{{ emp }}" {% if emp in emp_selected %}checked{% endif %} data-sv-check="emp">
              <span>{{ emp }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="sv-card">
        <div class="sv-card__header">
          <div>
            <div class="sv-card__title">Vendedor</div>
            <div class="sv-muted">Opcional</div>
          </div>
          <button type="button" class="sv-btn sv-btn--sm sv-btn--ghost" data-sv-checkall="vendedor">Marcar todas</button>
        </div>
        <div class="sv-card__body sv-scrollbox">
          {% for vend in vendedor_options %}
            <label class="sv-check">
              <input type="checkbox" name="vendedor" value="{{ vend }}" {% if vend in vendedor_selected %}checked{% endif %} data-sv-check="vendedor">
              <span>{{ vend }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="sv-row sv-row--end sv-mt-3">
      <div class="sv-field sv-field--inline">
        <label>Por página</label>
        <select class="sv-select" name="per_page">
          {% for n in [25,50,100,200,500] %}
            <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{n}}</option>
          {% endfor %}
        </select>
      </div>
      <button class="sv-btn sv-btn--primary" type="submit">Aplicar filtros</button>
      <a class="sv-btn sv-btn--ghost" href="{{ url_for('campanhas_qtd') }}">Limpar</a>
    </div>
  </form>

  {# ===== KPIs ===== #}
  {% set total_valor = 0.0 %}
  {% set total_vendedores = 0 %}
  {% set total_campanhas = 0 %}
  {% for b in blocos %}
    {% set total_valor = total_valor + (b.total_valor or 0.0) %}
    {% set total_vendedores = total_vendedores + 1 %}
    {% set total_campanhas = total_campanhas + (b.resultados|length) %}
  {% endfor %}

  <div class="sv-grid sv-grid--4 sv-mt-3">
    <div class="sv-kpi">
      <div class="sv-kpi__label">Total (R$)</div>
      <div class="sv-kpi__value">{{ total_valor|brl_rs }}</div>
      <div class="sv-kpi__hint">{{ total_campanhas }} campanhas • {{ total_vendedores }} vendedores</div>
    </div>
    <div class="sv-kpi">
      <div class="sv-kpi__label">Vendedores</div>
      <div class="sv-kpi__value">{{ total_vendedores }}</div>
      <div class="sv-kpi__hint">Agrupado por vendedor</div>
    </div>
    <div class="sv-kpi">
      <div class="sv-kpi__label">Campanhas</div>
      <div class="sv-kpi__value">{{ total_campanhas }}</div>
      <div class="sv-kpi__hint">Somatório das campanhas exibidas</div>
    </div>
    <div class="sv-kpi">
      <div class="sv-kpi__label">Período</div>
      <div class="sv-kpi__value">{{ "%02d"|format(mes|int) }}/{{ ano }}</div>
      <div class="sv-kpi__hint">Filtros aplicados</div>
    </div>
  </div>

  <div class="sv-panel sv-mt-3">
    <div class="sv-panel__header">
      <div>
        <div class="sv-panel__title">Tabela detalhada</div>
        <div class="sv-muted">Abra <b>Ver campanhas</b> para listar as campanhas do vendedor.</div>
      </div>
      <div class="sv-muted">Linhas: {{ blocos|length }}</div>
    </div>

    <div class="sv-tablewrap">
      <table class="sv-table">
        <thead>
          <tr>
            <th style="width: 90px;">EMP</th>
            <th>Vendedor</th>
            <th style="width: 340px;">Campanhas</th>
            <th class="sv-right" style="width: 140px;">Total (R$)</th>
          </tr>
        </thead>
        <tbody>
          {% for b in blocos %}
            <tr>
              <td class="sv-mono">{{ b.emp }}</td>
              <td>
                <div class="sv-strong">{{ b.vendedor }}</div>
                <div class="sv-muted">Campanhas: {{ b.resultados|length }}</div>
              </td>
              <td>
                <details class="sv-acc sv-acc--inline">
                  <summary class="sv-acc__sum">
                    <span class="sv-acc__label">Ver campanhas ({{ b.resultados|length }})</span>
                    <span class="sv-acc__chev" aria-hidden="true"></span>
                  </summary>
                  <div class="sv-acc__body">
                    <table class="sv-subtable">
                      <thead>
                        <tr>
                          <th>Campanha</th>
                          <th class="sv-right" style="width: 120px;">Qtd mín.</th>
                          <th class="sv-right" style="width: 140px;">Prêmio</th>
                          <th class="sv-right" style="width: 120px;">Vendeu</th>
                          <th class="sv-right" style="width: 140px;">Valor (R$)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in b.resultados %}
                          <tr>
                            <td class="sv-strong">{{ r.titulo }}</td>
                            <td class="sv-right">{{ r.qtd_minima }}</td>
                            <td class="sv-right">{{ r.premio|brl_rs }}</td>
                            <td class="sv-right">{{ r.qtd_vendida }}</td>
                            <td class="sv-right">{{ r.valor_total|brl_rs }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </details>
              </td>
              <td class="sv-right sv-strong">{{ b.total_valor|brl_rs }}</td>
            </tr>
          {% endfor %}
          {% if blocos|length == 0 %}
            <tr><td colspan="4" class="sv-muted">Nenhum resultado para os filtros selecionados.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
