{% extends "base.html" %}

{% block title %}Campanhas{% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:700; letter-spacing:-.3px}
  .subtitle{color:var(--bs-secondary-color)}
  .mono{font-variant-numeric: tabular-nums;}
  .emp-card{border:1px solid rgba(0,0,0,.08); border-radius:1rem}
  .vend-card{border:1px solid rgba(0,0,0,.08); border-radius:1rem}
  .excel-table thead th{white-space:nowrap}
  .status-dot{display:inline-flex; align-items:center; justify-content:center; width:1.8rem; height:1.8rem; border-radius:999px; font-weight:800}
  .dot-green{background:rgba(25,135,84,.12); color:#198754}
  .dot-yellow{background:rgba(255,193,7,.18); color:#b58100}
  .dot-red{background:rgba(220,53,69,.14); color:#dc3545}
  details > summary{cursor:pointer; user-select:none}
  details summary::-webkit-details-marker{display:none}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h3 class="page-title m-0">Campanhas</h3>
      <div class="subtitle">Parciais do mÃªs (QTD + COMBO)</div>
    </div>
  </div>

  <form method="get" class="card shadow-sm border-0 mb-3" style="border-radius:1rem">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-6 col-md-2">
          <label class="form-label small">MÃªs</label>
          <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label small">Ano</label>
          <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}">
        </div>

        {% if role == "admin" or role == "supervisor" %}
          <div class="col-12 col-md-4">
            <label class="form-label small">Vendedor(es)</label>
            <select class="form-select" name="vendedor" multiple>
              {% for v in vendedores_options %}
                <option value="{{ v }}" {% if vendedores_sel and (v in vendedores_sel) %}selected{% endif %}>{{ v }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Dica: segure Ctrl para selecionar vÃ¡rios.</div>
          </div>
        {% endif %}

        {% if role == "admin" %}
          <div class="col-12 col-md-4">
            <label class="form-label small">EMP(s)</label>
            <select class="form-select" name="emp" multiple>
              {% for o in emps_options %}
                <option value="{{ o.value }}" {% if emps_sel and (o.value|string in emps_sel) %}selected{% endif %}>{{ o.label }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Se vazio: mostra EMPs com vendas no perÃ­odo.</div>
          </div>
        {% endif %}

        <div class="col-12 col-md-2">
          <button class="btn btn-primary w-100">Atualizar</button>
        </div>
      </div>
    </div>
  </form>

  {% if not emps_data %}
    <div class="alert alert-warning">Nenhum dado encontrado para o perÃ­odo/escopo.</div>
  {% endif %}

  <div class="d-flex flex-column gap-3">
    {% for e in emps_data %}
      {% set cid = "emp_" ~ loop.index %}
      <div class="card emp-card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div class="d-flex align-items-center gap-2">
              {% if e.status == "green" %}
                <span class="status-dot dot-green">ðŸŸ¢</span>
              {% elif e.status == "yellow" %}
                <span class="status-dot dot-yellow">ðŸŸ¡</span>
              {% else %}
                <span class="status-dot dot-red">ðŸ”´</span>
              {% endif %}
              <div>
                <div class="subtitle small">Loja</div>
                <div class="h5 m-0 fw-bold">EMP {{ e.emp }}</div>
              </div>
            </div>

            <div class="text-end">
              <div class="subtitle small">Total</div>
              <div class="h5 m-0 fw-bold mono">{{ e.total|brl }}</div>
            </div>
          </div>

          <div class="mt-2 d-flex flex-wrap gap-2">
            <span class="badge text-bg-light border">QTD: <strong>{{ e.qtd_ok }}</strong>/{{ e.qtd_total }}</span>
            <span class="badge text-bg-light border">COMBO: <strong>{{ e.combo_ok }}</strong>/{{ e.combo_total }}</span>
          </div>

          {% if role == "admin" %}
            <div class="mt-3">
              <button class="btn btn-outline-secondary btn-sm" type="button"
                      data-bs-toggle="collapse" data-bs-target="#{{ cid }}">
                Ver vendedores
              </button>
            </div>
            <div class="collapse mt-3" id="{{ cid }}">
              {% for v in e.vendedores %}
                <div class="card vend-card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="fw-bold">ðŸ‘¤ {{ v.nome }}</div>
                      <div class="mono fw-bold">{{ v.total|brl }}</div>
                    </div>

                    <div class="table-responsive mt-2">
                      <table class="table table-sm align-middle excel-table mb-0">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Campanha / Combo</th>
                            <th>Marca</th>
                            <th>Status</th>
                            <th>Parcial</th>
                            <th>Recompensa</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for r in v.linhas %}
                            <tr>
                              <td>
                                {% if r.tipo == "QTD" %}
                                  <span class="badge text-bg-info">QTD</span>
                                {% else %}
                                  <span class="badge text-bg-warning">COMBO</span>
                                {% endif %}
                              </td>
                              <td>
                                <div class="fw-semibold">{{ r.titulo }}</div>
                                <div class="text-muted small">{{ r.periodo }}</div>
                              </td>
                              <td class="text-muted">{{ r.marca }}</td>
                              <td>
                                {% if r.tipo == "QTD" %}
                                  {% if r.atingiu == 1 %}
                                    <span class="badge text-bg-success">Atingiu</span>
                                  {% else %}
                                    <span class="badge text-bg-secondary">Pendente</span>
                                  {% endif %}
                                {% else %}
                                  {% if r.gate_ok == 1 %}
                                    <span class="badge text-bg-success">Gate OK</span>
                                  {% else %}
                                    <span class="badge text-bg-danger">Gate NOK</span>
                                  {% endif %}
                                {% endif %}
                              </td>
                              <td class="small">
                                {% if r.tipo == "COMBO" %}
                                  <span class="badge text-bg-light border">Progresso: {{ r.parcial|default("-") }}</span>
                                  <div class="text-muted mt-1">{{ r.critico|default("") }}</div>
                                  {% if r.detalhes %}
                                    <details class="mt-1">
                                      <summary class="small text-primary">Ver itens do kit</summary>
                                      <div class="table-responsive mt-2">
                                        <table class="table table-sm table-bordered mb-0">
                                          <thead>
                                            <tr>
                                              <th>#</th>
                                              <th>Regra</th>
                                              <th>MÃ­n.</th>
                                              <th>Vend.</th>
                                              <th>Falta</th>
                                              <th>R$/un</th>
                                              <th>Subtotal</th>
                                              <th>OK</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {% for it in r.detalhes %}
                                              <tr>
                                                <td class="mono">{{ it.ordem }}</td>
                                                <td class="small">{{ it.match }}</td>
                                                <td class="mono">{{ it.minimo }}</td>
                                                <td class="mono">{{ it.qtd }}</td>
                                                <td class="mono">{{ it.faltam }}</td>
                                                <td class="mono">{{ it.unit|brl }}</td>
                                                <td class="mono">{{ it.subtotal|brl }}</td>
                                                <td>
                                                  {% if it.atingiu == 1 %}
                                                    <span class="badge text-bg-success">OK</span>
                                                  {% else %}
                                                    <span class="badge text-bg-danger">NOK</span>
                                                  {% endif %}
                                                </td>
                                              </tr>
                                            {% endfor %}
                                          </tbody>
                                        </table>
                                      </div>
                                      <div class="form-text mt-1">
                                        * A recompensa do combo sÃ³ Ã© paga quando o gate Ã© atingido. Enquanto isso, mostramos apenas o progresso e o que falta.
                                      </div>
                                    </details>
                                  {% endif %}
                                {% else %}
                                  â€”
                                {% endif %}
                              </td>
                              <td class="mono">
                                {% if r.tipo == "COMBO" and r.gate_ok != 1 %}
                                  â€”
                                {% else %}
                                  {{ r.valor_recompensa|brl }}
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            {# Supervisor/Vendedor: jÃ¡ expandido #}
            <div class="mt-3">
              {% for v in e.vendedores %}
                <div class="card vend-card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="fw-bold">ðŸ‘¤ {{ v.nome }}</div>
                      <div class="mono fw-bold">{{ v.total|brl }}</div>
                    </div>

                    <div class="table-responsive mt-2">
                      <table class="table table-sm align-middle excel-table mb-0">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Campanha / Combo</th>
                            <th>Marca</th>
                            <th>Status</th>
                            <th>Parcial</th>
                            <th>Recompensa</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for r in v.linhas %}
                            <tr>
                              <td>
                                {% if r.tipo == "QTD" %}
                                  <span class="badge text-bg-info">QTD</span>
                                {% else %}
                                  <span class="badge text-bg-warning">COMBO</span>
                                {% endif %}
                              </td>
                              <td>
                                <div class="fw-semibold">{{ r.titulo }}</div>
                                <div class="text-muted small">{{ r.periodo }}</div>
                              </td>
                              <td class="text-muted">{{ r.marca }}</td>
                              <td>
                                {% if r.tipo == "QTD" %}
                                  {% if r.atingiu == 1 %}
                                    <span class="badge text-bg-success">Atingiu</span>
                                  {% else %}
                                    <span class="badge text-bg-secondary">Pendente</span>
                                  {% endif %}
                                {% else %}
                                  {% if r.gate_ok == 1 %}
                                    <span class="badge text-bg-success">Gate OK</span>
                                  {% else %}
                                    <span class="badge text-bg-danger">Gate NOK</span>
                                  {% endif %}
                                {% endif %}
                              </td>
                              <td class="small">
                                {% if r.tipo == "COMBO" %}
                                  <span class="badge text-bg-light border">Progresso: {{ r.parcial|default("-") }}</span>
                                  <div class="text-muted mt-1">{{ r.critico|default("") }}</div>
                                  {% if r.detalhes %}
                                    <details class="mt-1">
                                      <summary class="small text-primary">Ver itens do kit</summary>
                                      <div class="table-responsive mt-2">
                                        <table class="table table-sm table-bordered mb-0">
                                          <thead>
                                            <tr>
                                              <th>#</th>
                                              <th>Regra</th>
                                              <th>MÃ­n.</th>
                                              <th>Vend.</th>
                                              <th>Falta</th>
                                              <th>R$/un</th>
                                              <th>Subtotal</th>
                                              <th>OK</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {% for it in r.detalhes %}
                                              <tr>
                                                <td class="mono">{{ it.ordem }}</td>
                                                <td class="small">{{ it.match }}</td>
                                                <td class="mono">{{ it.minimo }}</td>
                                                <td class="mono">{{ it.qtd }}</td>
                                                <td class="mono">{{ it.faltam }}</td>
                                                <td class="mono">{{ it.unit|brl }}</td>
                                                <td class="mono">{{ it.subtotal|brl }}</td>
                                                <td>
                                                  {% if it.atingiu == 1 %}
                                                    <span class="badge text-bg-success">OK</span>
                                                  {% else %}
                                                    <span class="badge text-bg-danger">NOK</span>
                                                  {% endif %}
                                                </td>
                                              </tr>
                                            {% endfor %}
                                          </tbody>
                                        </table>
                                      </div>
                                      <div class="form-text mt-1">
                                        * A recompensa do combo sÃ³ Ã© paga quando o gate Ã© atingido. Enquanto isso, mostramos apenas o progresso e o que falta.
                                      </div>
                                    </details>
                                  {% endif %}
                                {% else %}
                                  â€”
                                {% endif %}
                              </td>
                              <td class="mono">
                                {% if r.tipo == "COMBO" and r.gate_ok != 1 %}
                                  â€”
                                {% else %}
                                  {{ r.valor_recompensa|brl }}
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}

        </div>
      </div>
    {% endfor %}
  </div>

</div>
{% endblock %}
