<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Importar Vendas - Admin</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .dropzone {
      border: 2px dashed rgba(255,255,255,.25);
      border-radius: 14px;
      padding: 22px;
      background: rgba(255,255,255,.03);
      transition: .15s ease;
    }
    .dropzone.dragover {
      border-color: rgba(13,110,253,.8);
      background: rgba(13,110,253,.08);
    }
    .small-muted { color: rgba(255,255,255,.65); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-dark text-light">
  <div class="container py-4" style="max-width: 980px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">üì• Importar Vendas</h3>
        <div class="small-muted">Envie uma planilha (.xlsx) para atualizar as vendas no banco.</div>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="/dashboard">Voltar</a>
        <a class="btn btn-outline-info btn-sm" href="/admin/usuarios">Usu√°rios</a>
      </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-3">
      <div class="col-lg-7">
        <div class="card bg-black border border-secondary rounded-4 shadow-sm">
          <div class="card-body p-4">
            <h5 class="card-title mb-1">Enviar arquivo</h5>
            <p class="small-muted mb-3">
              Se poss√≠vel, use o modelo com as colunas corretas. O sistema vai ignorar duplicidades pelo crit√©rio definido.
            </p>

            <form action="/admin/importar" method="POST" enctype="multipart/form-data" id="formImport">
              <div class="dropzone" id="dropzone">
                <div class="d-flex align-items-start gap-3">
                  <div class="fs-3">üìÑ</div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">Arraste a planilha aqui</div>
                    <div class="small-muted">ou clique para selecionar um arquivo .xlsx</div>
                    <input class="form-control mt-3" type="file" name="arquivo" id="arquivo"
                           accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                    <div class="small-muted mt-2" id="fileInfo">Nenhum arquivo selecionado.</div>
                  </div>
                </div>
              </div>

              <hr class="border-secondary my-4">

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Modo de importa√ß√£o</label>
                  <select class="form-select" name="modo">
                    <option value="ignorar_duplicados" selected>Ignorar duplicados (recomendado)</option>
                    <option value="atualizar">Atualizar se j√° existir</option>
                  </select>
                  <div class="form-text text-light small-muted">
                    ‚ÄúIgnorar duplicados‚Äù evita repetir vendas j√° importadas.
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Chave anti-duplicidade</label>
                  <select class="form-select" name="chave">
                    <option value="mestre_vendedor_nota_emp" selected>MESTRE + VENDEDOR + NOTA + EMP</option>
                    <option value="mestre_vendedor_nota">MESTRE + VENDEDOR + NOTA</option>
                  </select>
                  <div class="form-text text-light small-muted">
                    Se sua NOTA pode repetir em lojas diferentes, use a op√ß√£o com EMP.
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mt-4">
                <button class="btn btn-primary" type="submit">Importar agora</button>
                <a class="btn btn-outline-secondary" href="/admin/importar">Limpar</a>
              </div>

              <div class="small-muted mt-3">
                Dica: se o Render estiver ‚Äúdormindo‚Äù, a primeira importa√ß√£o pode demorar alguns segundos.
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card bg-black border border-secondary rounded-4 shadow-sm">
          <div class="card-body p-4">
            <h5 class="card-title">üìå Formato da planilha</h5>
            <p class="small-muted mb-3">
              A planilha deve conter as colunas abaixo (nomes exatamente assim):
            </p>

            <div class="border border-secondary rounded-3 p-3 mono small">
              MESTRE<br>
              MARCA<br>
              MOVIMENTO<br>
              MOV_TIPO_MOVTO<br>
              VENDEDOR<br>
              NOTA<br>
              EMP<br>
              UNIT<br>
              DES<br>
              QTDADE_VENDIDA<br>
              VALOR_TOTAL
            </div>

            <hr class="border-secondary my-4">

            <h6 class="mb-2">Como voc√™ descreveu:</h6>
            <ul class="small-muted mb-0">
              <li><span class="mono">MOVIMENTO</span> = data do movimento</li>
              <li><span class="mono">NOTA</span> pode repetir, mas n√£o para o mesmo vendedor/loja (por isso a chave com EMP √© a melhor)</li>
              <li><span class="mono">VALOR_TOTAL</span> = (UNIT - DES) √ó QTDADE_VENDIDA</li>
            </ul>
          </div>
        </div>

        <div class="card bg-black border border-secondary rounded-4 shadow-sm mt-3">
          <div class="card-body p-4">
            <h5 class="card-title">‚úÖ Sugest√£o de fluxo</h5>
            <ul class="small-muted mb-0">
              <li>Todo dia o ADMIN importa o arquivo ‚Äúdo dia‚Äù.</li>
              <li>O sistema ignora duplicados e s√≥ adiciona o que for novo.</li>
              <li>Isso mant√©m o banco sempre atualizado sem precisar do seu PC.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <footer class="small-muted mt-4">
      Se quiser, eu tamb√©m deixo um bot√£o no Dashboard do ADMIN apontando para <span class="mono">/admin/importar</span>.
    </footer>
  </div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const input = document.getElementById("arquivo");
    const fileInfo = document.getElementById("fileInfo");

    dropzone.addEventListener("click", () => input.click());

    function setInfo() {
      if (input.files && input.files[0]) {
        fileInfo.textContent = "Selecionado: " + input.files[0].name;
      } else {
        fileInfo.textContent = "Nenhum arquivo selecionado.";
      }
    }
    input.addEventListener("change", setInfo);

    ["dragenter","dragover"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("dragover");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        setInfo();
      }
    });

    setInfo();
  </script>
</body>
</html>
