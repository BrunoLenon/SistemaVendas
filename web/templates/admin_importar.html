<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Importar Vendas - Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .soft-shadow { box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    .dropzone {
      border: 2px dashed rgba(13,110,253,.35);
      border-radius: 16px;
      padding: 18px;
      background: rgba(13,110,253,.03);
      transition: .15s ease-in-out;
      cursor: pointer;
    }
    .dropzone.dragover {
      background: rgba(13,110,253,.06);
      border-color: rgba(13,110,253,.6);
    }
    .metric {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .muted { color: rgba(0,0,0,.62); }
    .pill {
      font-size: .75rem;
      padding: .25rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.70);
      white-space: nowrap;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .step-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      background: rgba(13,110,253,.12);
      color: #0d6efd;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4" style="max-width: 1100px;">

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <h3 class="mb-0">üì• Importar Vendas</h3>
        <div class="muted">Envie a planilha (.xlsx). O sistema ignora duplicados e mant√©m hist√≥rico.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/dashboard">Voltar</a>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} mb-2" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-3">
      <!-- COLUNA ESQUERDA -->
      <div class="col-lg-7">

        <!-- STEP 1 -->
        <div class="card border-0 soft-shadow mb-3">
          <div class="card-body p-4">
            <div class="d-flex align-items-start gap-2 mb-2">
              <span class="step-badge">1</span>
              <div class="flex-grow-1">
                <div class="fw-semibold">Enviar arquivo e op√ß√µes</div>
                <div class="muted small">Arraste a planilha para a √°rea abaixo ou clique para selecionar.</div>
              </div>
              <span class="pill">Seguro reprocessar</span>
            </div>

            <form action="/admin/importar" method="POST" enctype="multipart/form-data" id="formImport">
              <div class="dropzone" id="dropzone">
                <div class="d-flex align-items-start gap-3">
                  <div class="fs-3">üìÑ</div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">Planilha de vendas (.xlsx)</div>
                    <div class="muted small">Clique aqui ou arraste o arquivo para importar</div>

                    <input class="form-control mt-3" type="file" name="arquivo" id="arquivo"
                          accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                    <div class="muted small mt-2" id="fileInfo">Nenhum arquivo selecionado.</div>
                  </div>
                </div>
              </div>

              <hr class="my-4">

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Modo de importa√ß√£o</label>
                  <select class="form-select" name="modo">
                    <option value="ignorar_duplicados" selected>Ignorar duplicados (recomendado)</option>
                    <option value="atualizar">Atualizar se j√° existir</option>
                  </select>
                  <div class="form-text">‚ÄúIgnorar duplicados‚Äù evita repetir vendas j√° importadas.</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Chave anti-duplicidade (considera MOV_TIPO_MOVTO)</label>
                  <select class="form-select" name="chave">
                    <option value="mestre_movimento_vendedor_nota_tipo_emp" selected>MESTRE + MARCA + MOVIMENTO + VENDEDOR + NOTA + MOV_TIPO_MOVTO + EMP (recomendado)</option>
                    <option value="mestre_marca_movimento_vendedor_nota_tipo_emp">(mesma chave) Nome expl√≠cito com MARCA</option>
                    <option value="mestre_movimento_vendedor_nota_emp">MESTRE + MARCA + MOVIMENTO + VENDEDOR + NOTA + EMP</option>
                  </select>
                  <div class="form-text">Se sua NOTA pode repetir em lojas diferentes, use a op√ß√£o com EMP.</div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-4">
                <button class="btn btn-primary btn-lg" type="submit" id="btnImportar">Importar agora</button>
                <a class="btn btn-outline-secondary btn-lg" href="/admin/importar">Limpar</a>
              </div>

              <div class="row g-3 mt-3">
                <div class="col-12 col-md-4">
                  <div class="p-3 rounded-3 bg-white border h-100">
                    <div class="fw-semibold">‚úî Deduplica√ß√£o</div>
                    <div class="muted small">Ignora vendas repetidas automaticamente.</div>
                  </div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="p-3 rounded-3 bg-white border h-100">
                    <div class="fw-semibold">‚úî Hist√≥rico</div>
                    <div class="muted small">Mant√©m dados para relat√≥rios e comparativos.</div>
                  </div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="p-3 rounded-3 bg-white border h-100">
                    <div class="fw-semibold">‚úî Auditoria</div>
                    <div class="muted small">Logs no Render para confer√™ncia.</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="processingCard" class="card border-0 soft-shadow mb-3 d-none">
          <div class="card-body p-4">
            <div class="d-flex align-items-start gap-2 mb-2">
              <span class="step-badge">2</span>
              <div>
                <div class="fw-semibold">Processando</div>
                <div class="muted small">N√£o feche esta p√°gina. Pode levar alguns segundos.</div>
              </div>
            </div>

            <div class="d-flex align-items-center gap-3">
              <div class="spinner-border" role="status" aria-label="Processando..."></div>
              <div>
                <div class="fw-semibold">Estamos importando sua planilha‚Ä¶</div>
                <div class="muted small">Ao finalizar, voc√™ ver√° o resultado no topo da p√°gina.</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- COLUNA DIREITA -->
      <div class="col-lg-5">
        <!-- AJUDA -->
        <div class="card border-0 soft-shadow mb-3">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between gap-2">
              <h5 class="mb-0">üìå Formato da planilha</h5>
              <span class="pill">Cabe√ßalhos exatos</span>
            </div>
            <p class="muted mb-3 mt-2">As colunas devem existir (nomes exatamente assim):</p>

            <div class="border rounded-3 p-3 mono small bg-light">
              MESTRE<br>MARCA<br>MOVIMENTO<br>MOV_TIPO_MOVTO<br>VENDEDOR<br>NOTA<br>EMP<br>UNIT<br>DES<br>QTDADE_VENDIDA<br>VALOR_TOTAL
              <br><br>
              <span class="muted">(+ opcionais)</span><br>
              DESCRICAO<br>RAZAO<br>CIDADE<br>CNPJ_CPF
            </div>

            <div class="muted mt-3">
              Dica: mantenha <span class="mono">VENDEDOR</span> igual ao login do vendedor.
            </div>
          </div>
        </div>

        <!-- APAGAR IMPORTA√á√ïES -->
        <div class="card border-0 soft-shadow">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center gap-2">
              <h5 class="mb-0">üßπ Apagar importa√ß√µes</h5>
              <span class="pill">A√ß√£o irrevers√≠vel</span>
            </div>
            <div class="muted mt-2">
              Apague vendas por <strong>dia</strong> ou por <strong>m√™s</strong>. Isso ajuda a corrigir importa√ß√µes.
            </div>

            <ul class="nav nav-pills mt-3" id="tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-dia" data-bs-toggle="pill" data-bs-target="#painel-dia" type="button" role="tab">Por dia</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-mes" data-bs-toggle="pill" data-bs-target="#painel-mes" type="button" role="tab">Por m√™s</button>
              </li>
            </ul>

            <div class="tab-content mt-3">
              <div class="tab-pane fade show active" id="painel-dia" role="tabpanel">
                <form method="POST" action="/admin/apagar_vendas" onsubmit="return confirmDelete(this);">
                  <input type="hidden" name="tipo" value="dia">
                  <label class="form-label">Selecione o dia</label>
                  <input class="form-control" type="date" name="valor" required>
                  <button class="btn btn-danger w-100 mt-3" type="submit">Apagar vendas do dia</button>
                  <div class="muted small mt-2">Use quando importou algo errado em um dia espec√≠fico.</div>
                </form>
              </div>

              <div class="tab-pane fade" id="painel-mes" role="tabpanel">
                <form method="POST" action="/admin/apagar_vendas" onsubmit="return confirmDelete(this);">
                  <input type="hidden" name="tipo" value="mes">
                  <label class="form-label">Selecione o m√™s</label>
                  <input class="form-control" type="month" name="valor" required>
                  <button class="btn btn-danger w-100 mt-3" type="submit">Apagar vendas do m√™s</button>
                  <div class="muted small mt-2">Use quando uma planilha do m√™s inteiro foi importada indevidamente.</div>
                </form>
              </div>
            </div>

            <hr class="my-4">
            <div class="muted small">
              <strong>Observa√ß√£o:</strong> o sistema apaga pelo campo <span class="mono">movimento</span> na tabela <span class="mono">vendas</span>.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const dropzone = document.getElementById("dropzone");
    const input = document.getElementById("arquivo");
    const fileInfo = document.getElementById("fileInfo");
    const formImport = document.getElementById("formImport");
    const processingCard = document.getElementById("processingCard");
    const btnImportar = document.getElementById("btnImportar");

    dropzone.addEventListener("click", () => input.click());

    function setInfo() {
      if (input.files && input.files[0]) fileInfo.textContent = "Selecionado: " + input.files[0].name;
      else fileInfo.textContent = "Nenhum arquivo selecionado.";
    }
    input.addEventListener("change", setInfo);

    ["dragenter","dragover"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove("dragover");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        setInfo();
      }
    });

    formImport.addEventListener("submit", (e) => {
      if (!input.files || !input.files.length) {
        e.preventDefault();
        alert("Selecione um arquivo .xlsx para importar.");
        return;
      }
      processingCard.classList.remove("d-none");
      btnImportar.disabled = true;
      btnImportar.innerText = "Importando...";
    });

    function confirmDelete(form){
      const tipo = form.querySelector('input[name="tipo"]').value;
      const valor = form.querySelector('input[name="valor"]').value;
      const label = (tipo === "dia") ? ("do dia " + valor) : ("do m√™s " + valor);
      return confirm("Tem certeza que deseja APAGAR TODAS as vendas " + label + "?\n\nEssa a√ß√£o n√£o pode ser desfeita.");
    }

    setInfo();
  </script>
</body>
</html>
