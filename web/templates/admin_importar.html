<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Importar Vendas - Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --card-bg: rgba(255,255,255,.06);
      --card-bd: rgba(255,255,255,.14);
      --muted: rgba(255,255,255,.70);
    }
    body{
      min-height: 100vh;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(13,110,253,.22), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(32,201,151,.16), transparent 55%),
        radial-gradient(900px 700px at 30% 90%, rgba(111,66,193,.18), transparent 60%),
        #0b0f19;
      color: #fff;
    }
    .app-shell{ max-width: 1100px; }
    .glass{
      background: var(--card-bg);
      border: 1px solid var(--card-bd);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .small-muted{ color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .dropzone{
      border: 2px dashed rgba(255,255,255,.22);
      border-radius: 16px;
      padding: 22px;
      background: rgba(255,255,255,.04);
      transition: .15s ease;
      cursor: pointer;
    }
    .dropzone.dragover{ border-color: rgba(13,110,253,.85); background: rgba(13,110,253,.10); }
    .btn-soft{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.16);
      color: #fff;
    }
    .btn-soft:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); color:#fff; }
    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .7rem; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      font-size: .9rem;
      color: rgba(255,255,255,.86);
    }
  </style>
</head>

<body>
  <div class="container py-4 app-shell">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div>
        <div class="d-flex align-items-center gap-2">
          <h3 class="mb-0">üì• Importar Vendas</h3>
          <span class="pill">Admin</span>
        </div>
        <div class="small-muted">Importe planilhas (.xlsx), evite duplicidades e gerencie remo√ß√µes por dia ou m√™s.</div>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-soft btn-sm" href="/dashboard">Voltar</a>
        <a class="btn btn-soft btn-sm" href="/admin/usuarios">Usu√°rios</a>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-3">
      <!-- IMPORTAR -->
      <div class="col-lg-7">
        <div class="glass p-4">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <h5 class="mb-1">Enviar arquivo</h5>
              <div class="small-muted">Arraste e solte ou selecione uma planilha para importar.</div>
            </div>
            <span class="pill">‚ö° Dica: primeira execu√ß√£o pode demorar</span>
          </div>

          <form action="/admin/importar" method="POST" enctype="multipart/form-data" id="formImport" class="mt-3">
            <div class="dropzone" id="dropzone">
              <div class="d-flex align-items-start gap-3">
                <div class="fs-3">üìÑ</div>
                <div class="flex-grow-1">
                  <div class="fw-semibold">Arraste a planilha aqui</div>
                  <div class="small-muted">ou clique para selecionar um arquivo .xlsx</div>
                  <input class="form-control mt-3" type="file" name="arquivo" id="arquivo"
                         accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                  <div class="small-muted mt-2" id="fileInfo">Nenhum arquivo selecionado.</div>
                </div>
              </div>
            </div>

            <hr class="border-light border-opacity-10 my-4">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Modo de importa√ß√£o</label>
                <select class="form-select" name="modo">
                  <option value="ignorar_duplicados" selected>Ignorar duplicados (recomendado)</option>
                  <option value="atualizar">Atualizar se j√° existir</option>
                </select>
                <div class="form-text small-muted">
                  ‚ÄúIgnorar duplicados‚Äù evita repetir vendas j√° importadas.
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Chave anti-duplicidade (considera MOV_TIPO_MOVTO)</label>
                <select class="form-select" name="chave">
                  <option value="mestre_movimento_vendedor_nota_tipo_emp" selected>MESTRE + MARCA + MOVIMENTO + VENDEDOR + NOTA + MOV_TIPO_MOVTO + EMP (recomendado)</option>
                  <option value="mestre_marca_movimento_vendedor_nota_tipo_emp">(mesma chave) Nome expl√≠cito com MARCA</option>
                  <option value="mestre_movimento_vendedor_nota_emp">MESTRE + MARCA + MOVIMENTO + VENDEDOR + NOTA + EMP</option>
                </select>
                <div class="form-text small-muted">
                  Se sua NOTA pode repetir em lojas diferentes, use a op√ß√£o com EMP.
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <button class="btn btn-primary" type="submit">Importar agora</button>
              <a class="btn btn-soft" href="/admin/importar">Limpar</a>
            </div>
          </form>
        </div>
      </div>

      <!-- AJUDA + LIMPAR -->
      <div class="col-lg-5">
        <div class="glass p-4 mb-3">
          <h5 class="mb-2">üìå Formato da planilha</h5>
          <p class="small-muted mb-3">As colunas devem existir (nomes exatamente assim):</p>

          <div class="border border-light border-opacity-10 rounded-3 p-3 mono small"
               style="background: rgba(0,0,0,.25);">
            MESTRE<br>MARCA<br>MOVIMENTO<br>MOV_TIPO_MOVTO<br>VENDEDOR<br>NOTA<br>EMP<br>UNIT<br>DES<br>QTDADE_VENDIDA<br>VALOR_TOTAL
          </div>

          <div class="small-muted mt-3">
            Dica: mantenha o <span class="mono">VENDEDOR</span> igual ao login do vendedor.
          </div>
        </div>

        <div class="glass p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üßπ Apagar importa√ß√µes</h5>
            <span class="pill">A√ß√£o irrevers√≠vel</span>
          </div>
          <div class="small-muted mt-2">
            Apague vendas por <strong>dia</strong> ou por <strong>m√™s</strong>. Isso ajuda a corrigir importa√ß√µes repetidas.
          </div>

          <ul class="nav nav-pills mt-3" id="tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-dia" data-bs-toggle="pill" data-bs-target="#painel-dia" type="button" role="tab">Por dia</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-mes" data-bs-toggle="pill" data-bs-target="#painel-mes" type="button" role="tab">Por m√™s</button>
            </li>
          </ul>

          <div class="tab-content mt-3">
            <div class="tab-pane fade show active" id="painel-dia" role="tabpanel">
              <form method="POST" action="/admin/apagar_vendas" onsubmit="return confirmDelete(this);">
                <input type="hidden" name="tipo" value="dia">
                <label class="form-label">Selecione o dia</label>
                <input class="form-control" type="date" name="valor" required>
                <div class="d-flex gap-2 mt-3">
                  <button class="btn btn-danger w-100" type="submit">Apagar vendas do dia</button>
                </div>
                <div class="small-muted mt-2">Use quando importou algo errado em um dia espec√≠fico.</div>
              </form>
            </div>

            <div class="tab-pane fade" id="painel-mes" role="tabpanel">
              <form method="POST" action="/admin/apagar_vendas" onsubmit="return confirmDelete(this);">
                <input type="hidden" name="tipo" value="mes">
                <label class="form-label">Selecione o m√™s</label>
                <input class="form-control" type="month" name="valor" required>
                <div class="d-flex gap-2 mt-3">
                  <button class="btn btn-danger w-100" type="submit">Apagar vendas do m√™s</button>
                </div>
                <div class="small-muted mt-2">Use quando uma planilha do m√™s inteiro foi importada indevidamente.</div>
              </form>
            </div>
          </div>

          <hr class="border-light border-opacity-10 my-4">

          <div class="small-muted">
            <strong>Observa√ß√£o:</strong> o sistema apaga pelo campo <span class="mono">movimento</span> na tabela <span class="mono">vendas</span>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const dropzone = document.getElementById("dropzone");
    const input = document.getElementById("arquivo");
    const fileInfo = document.getElementById("fileInfo");

    dropzone.addEventListener("click", () => input.click());

    function setInfo() {
      if (input.files && input.files[0]) fileInfo.textContent = "Selecionado: " + input.files[0].name;
      else fileInfo.textContent = "Nenhum arquivo selecionado.";
    }
    input.addEventListener("change", setInfo);

    ["dragenter","dragover"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove("dragover");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        setInfo();
      }
    });

    function confirmDelete(form){
      const tipo = form.querySelector('input[name="tipo"]').value;
      const valor = form.querySelector('input[name="valor"]').value;
      const label = (tipo === "dia") ? ("do dia " + valor) : ("do m√™s " + valor);
      return confirm("Tem certeza que deseja APAGAR TODAS as vendas " + label + "?\n\nEssa a√ß√£o n√£o pode ser desfeita.");
    }

    setInfo();
  </script>
</body>
</html>
