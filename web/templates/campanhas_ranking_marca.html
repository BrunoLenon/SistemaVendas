{% extends "base.html" %}
{% block title %}Ranking por Marca{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px;">
  <div class="card glass p-3 mb-3">
    <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
      <div>
        <div class="text-muted small">OperaÃ§Ã£o / Ranking por Marca</div>
        <h2 class="m-0">Ranking por Marca</h2>
        <div class="text-muted small mt-1">
          Selecione uma campanha e um perÃ­odo. O ranking mostra <b>Vendido</b> (base) e <b>Recompensa</b> (prÃªmio).
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        {% if session.get("perfil") == "admin" %}
          <a class="btn btn-outline-light btn-sm" href="/admin/campanhas/ranking-marca">Cadastrar / Gerenciar</a>
        {% endif %}
        {% if campanha_selecionada and session.get("perfil") == "admin" %}
          <form method="post" action="/ranking-marca/recalcular" class="m-0">
            <input type="hidden" name="campanha_id" value="{{ campanha_selecionada.id }}">
            <input type="hidden" name="mes" value="{{ mes }}">
            <input type="hidden" name="ano" value="{{ ano }}">
            <button class="btn btn-warning btn-sm">Recalcular</button>
          </form>
        {% endif %}
      </div>
    </div>

    <form method="get" class="mt-3">
      <div class="row g-2">
        <div class="col-12 col-md-5">
          <label class="form-label small text-muted">Campanha</label>
          <select name="campanha_id" class="form-select">
            <option value="">Selecioneâ€¦</option>
            {% for c in campanhas %}
              <option value="{{ c.id }}" {% if campanha_selecionada and c.id == campanha_selecionada.id %}selected{% endif %}>
                {{ c.nome }} {% if c.marca_alvo %}â€” {{ c.marca_alvo }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">MÃªs</label>
          <input name="mes" class="form-control" value="{{ mes }}" placeholder="1-12">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Ano</label>
          <input name="ano" class="form-control" value="{{ ano }}" placeholder="ex: 2026">
        </div>

        <div class="col-12 col-md-3 d-flex align-items-end justify-content-end gap-2">
          <button class="btn btn-primary">Aplicar</button>
          <a class="btn btn-outline-light" href="/ranking-marca">Limpar</a>
        </div>
      </div>
    </form>
  </div>

  {% if campanha_selecionada %}
    {% set ns = namespace(total_vendido=0.0, total_premio=0.0, vendedores=0) %}
    {% for r in resultados %}
      {% set ns.total_vendido = ns.total_vendido + (r.valor_base or 0) %}
      {% set ns.total_premio = ns.total_premio + (r.premio or 0) %}
      {% set ns.vendedores = ns.vendedores + 1 %}
    {% endfor %}

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card glass p-3 h-100">
          <div class="text-muted small">Marca</div>
          <div class="h5 m-0">{{ campanha_selecionada.marca_alvo or "â€”" }}</div>
          <div class="text-muted small mt-2">PerÃ­odo</div>
          <div class="fw-semibold">{{ "%02d"|format(mes|int) }}/{{ ano }}</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card glass p-3 h-100">
          <div class="text-muted small">Escopo</div>
          <div class="h5 m-0">
            {% if campanha_selecionada.scope_mode == "GLOBAL" %}
              Global
            {% else %}
              Por EMP
            {% endif %}
          </div>
          <div class="text-muted small mt-2">Top 1 / Top 2 / Top 3</div>
          <div class="fw-semibold">
            R$ {{ "%.2f"|format(campanha_selecionada.premio_top1 or 0) }} /
            R$ {{ "%.2f"|format(campanha_selecionada.premio_top2 or 0) }} /
            R$ {{ "%.2f"|format(campanha_selecionada.premio_top3 or 0) }}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card glass p-3 h-100">
          <div class="text-muted small">Total vendido (base)</div>
          <div class="h5 m-0">R$ {{ "{:,.2f}".format(ns.total_vendido).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
          <div class="text-muted small mt-2">Vendedores</div>
          <div class="fw-semibold">{{ ns.vendedores }}</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card glass p-3 h-100">
          <div class="text-muted small">Total recompensa</div>
          <div class="h5 m-0">R$ {{ "{:,.2f}".format(ns.total_premio).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
          <div class="text-muted small mt-2">Regra</div>
          <div class="fw-semibold">Vendido + PrÃªmio</div>
        </div>
      </div>
    </div>

    <div class="card glass p-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="text-muted small">Ranking</div>
          <div class="h5 m-0">{{ campanha_selecionada.nome }}</div>
        </div>
        <div class="text-muted small">
          {% if campanha_selecionada.scope_mode == "GLOBAL" %}
            Mostrando todas as EMPs permitidas para seu perfil.
          {% else %}
            Mostrando apenas as EMPs vinculadas Ã  campanha (e ao seu perfil).
          {% endif %}
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-dark table-hover align-middle">
          <thead>
            <tr>
              <th style="width: 70px;">#</th>
              <th>Vendedor</th>
              <th style="width: 90px;">EMP</th>
              <th style="width: 170px;">Vendido (R$)</th>
              <th style="width: 170px;">Recompensa (R$)</th>
            </tr>
          </thead>
          <tbody>
            {% if resultados and resultados|length > 0 %}
              {% for r in resultados %}
                <tr>
                  <td class="fw-bold">
                    {% if r.posicao == 1 %}ðŸ¥‡{% elif r.posicao == 2 %}ðŸ¥ˆ{% elif r.posicao == 3 %}ðŸ¥‰{% endif %}
                    {{ r.posicao }}
                  </td>
                  <td>
                    <div class="fw-semibold">{{ r.vendedor }}</div>
                    {% if r.posicao in [1,2,3] %}
                      <div class="text-muted small">Top {{ r.posicao }}</div>
                    {% endif %}
                  </td>
                  <td class="text-muted">{{ r.emp }}</td>
                  <td class="fw-semibold">
                    R$ {{ "{:,.2f}".format(r.valor_base or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}
                  </td>
                  <td>
                    <span class="badge rounded-pill bg-warning text-dark">
                      R$ {{ "{:,.2f}".format(r.premio or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}
                    </span>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  Nenhum resultado para o perÃ­odo. Use <b>Recalcular</b> (Admin) ou verifique se hÃ¡ vendas importadas.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="card glass p-4 text-center text-muted">
      Selecione uma <b>campanha</b> para visualizar o ranking.
    </div>
  {% endif %}
</div>
{% endblock %}
