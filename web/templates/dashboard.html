<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Dashboard - {{ vendedor }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-sm td, .table-sm th { padding: .55rem; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">
        Dashboard ‚Äî
        <span class="text-primary">{{ vendedor }}</span>

        {% if role and role|lower == "admin" %}
          <span class="badge text-bg-dark ms-2">ADMIN</span>
        {% elif role and role|lower == "supervisor" %}
          <span class="badge text-bg-primary ms-2">SUPERVISOR</span>
          {% if emp %}
            <span class="badge text-bg-light border ms-2">EMP {{ emp }}</span>
          {% endif %}
        {% endif %}
      </h3>

      <div class="d-flex gap-2">
        {% if role and role|lower == "admin" %}
          <a class="btn btn-outline-dark btn-sm" href="/admin/usuarios">Usu√°rios</a>
          <a class="btn btn-outline-dark btn-sm" href="/admin/importar">Importar</a>
        {% endif %}
        <a class="btn btn-outline-primary btn-sm" href="/senha">Trocar senha</a>
        <a class="btn btn-outline-secondary btn-sm" href="/logout">Sair</a>
      </div>
    </div>

    {% if role and role|lower == "admin" %}
      <div class="alert alert-info shadow-sm">
        Voc√™ est√° logado como <strong>ADMIN</strong>. Use os bot√µes <strong>Usu√°rios</strong> e <strong>Importar</strong> acima para administrar o sistema.
      </div>
    {% elif role and role|lower == "supervisor" %}
      <div class="alert alert-info shadow-sm">
        Voc√™ est√° logado como <strong>SUPERVISOR</strong>{% if emp %} da <strong>EMP {{ emp }}</strong>{% endif %}.
        Selecione um vendedor para ver exatamente o mesmo painel que ele v√™.
      </div>
    {% endif %}

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <form method="get" action="/dashboard" class="row g-2 align-items-end">

          {% if role and role|lower == "supervisor" %}
            <div class="col-12 col-md-4">
              <label class="form-label">Vendedor</label>
              <select class="form-select" name="vendedor" required>
                {% if vendedores %}
                  {% for v in vendedores %}
                    <option value="{{ v }}" {% if vendedor_selecionado == v %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <option value="" selected>Nenhum vendedor encontrado para esta EMP</option>
                {% endif %}
              </select>
            </div>
          {% endif %}

          <div class="col-auto">
            <label class="form-label">M√™s</label>
            <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
          </div>
          <div class="col-auto">
            <label class="form-label">Ano</label>
            <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" type="submit">Atualizar</button>
          </div>
          <div class="col">
            <div class="text-end text-muted">Per√≠odo selecionado: <strong>{{ mes }}/{{ ano }}</strong></div>
          </div>
        </form>
      </div>
    </div>

    {% if dados %}
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted">üí∞ Valor l√≠quido (com DS/CA)</div>
              <div class="display-6">R$ {{ "{:,.2f}".format(dados.valor_atual) }}</div>
              <div class="text-muted mt-1">Ano passado: R$ {{ "{:,.2f}".format(dados.valor_ano_passado) }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted">üì¶ Mix de produtos</div>
              <div class="display-6">{{ dados.mix_atual }}</div>
              <div class="text-muted mt-1">Ano passado: {{ dados.mix_ano_passado }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted">üßæ Valor bruto (sem DS/CA)</div>
              <div class="h3 m-0">R$ {{ "{:,.2f}".format(dados.valor_bruto) }}</div>
              <div class="text-muted">Somente vendas</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted">‚Ü©Ô∏è Devolu√ß√µes/Cancelamentos (DS/CA)</div>
              <div class="h3 m-0">R$ {{ "{:,.2f}".format(dados.valor_devolvido) }}</div>
              <div class="text-muted">Total abatido</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted">üìâ % devolu√ß√£o (sobre bruto)</div>
              {% if dados.pct_devolucao is not none %}
                <div class="h3 m-0">{{ "%.2f"|format(dados.pct_devolucao) }}%</div>
              {% else %}
                <div class="h3 m-0">‚Äî</div>
                <div class="text-muted">Sem base</div>
              {% endif %}
              <div class="text-muted">Devolvido √∑ Bruto</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">üìà Crescimento vs m√™s anterior (l√≠quido)</div>
            <div class="text-muted">Compara√ß√£o do l√≠quido do m√™s selecionado com o m√™s anterior</div>
          </div>
          <div class="text-end">
            {% if dados.crescimento is not none %}
              {% if dados.crescimento >= 0 %}
                <span class="badge text-bg-success fs-6">+{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% else %}
                <span class="badge text-bg-danger fs-6">{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% endif %}
            {% else %}
              <span class="badge text-bg-secondary fs-6">Sem base</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">üìä Top 15 marcas ‚Äî Valor + % do total (l√≠quido)</h5>
            {% if role and role|lower == "supervisor" %}
              <a href="/percentuais?mes={{ mes }}&ano={{ ano }}&vendedor={{ vendedor_selecionado }}" class="btn btn-sm btn-outline-primary">Ver ranking completo</a>
            {% else %}
              <a href="/percentuais?mes={{ mes }}&ano={{ ano }}" class="btn btn-sm btn-outline-primary">Ver ranking completo</a>
            {% endif %}
          </div>
          <hr class="my-2">

          {% if dados.ranking_top15_list is not none and (dados.ranking_top15_list|length) > 0 %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width:60px;">#</th>
                    <th>Marca</th>
                    <th class="text-end">Valor</th>
                    <th class="text-end">% do total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in dados.ranking_top15_list %}
                    <tr>
                      <td class="text-muted">{{ loop.index }}</td>
                      <td>{{ row.marca }}</td>
                      <td class="text-end">R$ {{ "{:,.2f}".format(row.valor) }}</td>
                      <td class="text-end">{{ "%.2f"|format(row.pct) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">Sem dados no per√≠odo.</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        {% if role and role|lower == "supervisor" %}
          <a href="/percentuais?mes={{ mes }}&ano={{ ano }}&vendedor={{ vendedor_selecionado }}" class="btn btn-outline-primary">Ver ranking completo</a>
          <a href="/devolucoes?mes={{ mes }}&ano={{ ano }}&vendedor={{ vendedor_selecionado }}" class="btn btn-outline-secondary">Ver devolu√ß√µes (DS/CA)</a>
        {% else %}
          <a href="/percentuais?mes={{ mes }}&ano={{ ano }}" class="btn btn-outline-primary">Ver ranking completo</a>
          <a href="/devolucoes?mes={{ mes }}&ano={{ ano }}" class="btn btn-outline-secondary">Ver devolu√ß√µes (DS/CA)</a>
        {% endif %}
      </div>

    {% else %}
      {% if role and role|lower == "supervisor" and vendedores %}
        <div class="alert alert-warning shadow-sm">
          Selecione um vendedor e clique em <strong>Atualizar</strong>.
        </div>
      {% else %}
        <div class="alert alert-warning shadow-sm">
          Nenhum dado encontrado para este vendedor.
        </div>
      {% endif %}
    {% endif %}

  </div>
</body>
</html>
