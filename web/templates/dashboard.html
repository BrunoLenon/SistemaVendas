{% extends "base.html" %}

{% block title %}Dashboard - {{ vendedor or usuario }}{% endblock %}

{% block extra_head %}
<style>
  /* Refinos Power BI (somente visual) */
  .page-header{
    display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
    margin-bottom: 14px;
  }
  .page-header h3{ margin:0; letter-spacing:.2px; }
  .page-sub{ color: var(--muted, rgba(255,255,255,.65)); font-size:.92rem; }
  .glass.card{ border:1px solid rgba(255,255,255,.10); }
  .kpi{
    position:relative;
    overflow:hidden;
  }
  .kpi .kpi-label{ color: var(--muted, rgba(255,255,255,.65)); font-size:.82rem; }
  .kpi .kpi-value{ font-weight: 700; letter-spacing:.2px; }
  .kpi .kpi-foot{ color: var(--muted, rgba(255,255,255,.60)); font-size:.80rem; margin-top:4px; }
  .kpi::after{
    content:"";
    position:absolute; inset:auto -40px -60px auto;
    width:120px; height:120px;
    background: radial-gradient(circle at 30% 30%, rgba(13,110,253,.22), transparent 60%);
    transform: rotate(12deg);
    pointer-events:none;
  }
  .section-title{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    margin-bottom: 10px;
  }
  .section-title h5{ margin:0; }
  .table thead th{
    font-size:.80rem;
    color: var(--muted, rgba(255,255,255,.72));
    text-transform: uppercase;
    letter-spacing: .6px;
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .table tbody td{ border-top: 1px solid rgba(255,255,255,.06); }
  .mini-bar{
    height:8px;
    background: rgba(255,255,255,.08);
    border-radius: 999px;
    overflow:hidden;
  }
  .mini-bar > span{
    display:block; height:100%;
    background: rgba(13,110,253,.65);
    border-radius: 999px;
  }
  .badge-soft{
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.12);
    color: rgba(255,255,255,.86);
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  // UX: evita cliques repetidos e mostra spinner ao atualizar filtros
  (function(){
    const form = document.getElementById('filtersForm');
    const btn = document.getElementById('filtersSubmit');
    if (!form || !btn) return;
    form.addEventListener('submit', function(){
      btn.disabled = true;
      const sp = btn.querySelector('.spinner-border');
      const lb = btn.querySelector('.btn-label');
      if (lb) lb.textContent = 'Carregando...';
      if (sp) sp.classList.remove('d-none');
    });
  })();
</script>
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="page-header">
    <div>
      <h3 class="fw-semibold">ğŸ“Š Dashboard</h3>
      <div class="page-sub">
        {% if role %}<span class="badge badge-soft me-2">{{ role|upper }}</span>{% endif %}
        PerÃ­odo selecionado: <strong>{{ mes }}/{{ ano }}</strong>
        {% if vendedor_selecionado %} â€¢ Vendedor: <strong>{{ vendedor_selecionado }}</strong>{% endif %}
        {% if emp %} â€¢ EMP: <strong>{{ emp }}</strong>{% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap justify-content-end">
      <a class="btn btn-sm btn-outline-light" href="/relatorios/cidades-clientes">ğŸ™ï¸ Cidades/Clientes</a>
      <a class="btn btn-sm btn-outline-light" href="/relatorios/campanhas">ğŸ¯ Rel. Campanhas</a>
      <a class="btn btn-sm btn-outline-light" href="/campanhas">ğŸ“¦ Campanhas (Qtd)</a>
    </div>
  </div>

  {% if role and role|lower == "supervisor" %}
    <div class="alert alert-info glass card p-3 mb-3">
      VocÃª estÃ¡ logado como <strong>SUPERVISOR</strong>{% if emp %} da EMP <strong>{{ emp }}</strong>{% endif %}.
      Selecione um vendedor para ver exatamente o mesmo painel que ele vÃª.
    </div>
  {% endif %}

  <!-- Filtros -->
  <div class="glass card mb-3">
    <div class="card-body">
      <div class="section-title">
        <h5 class="fw-semibold mb-0">ğŸ” Filtros</h5>
        <div class="text-muted small">Atualize para recalcular o perÃ­odo</div>
      </div>

      <form id="filtersForm" method="get" action="{{ url_for('dashboard') }}" class="row g-2 align-items-end">

        {% if role and role|lower in ["admin", "supervisor"] %}
          <div class="col-md-4">
            <label class="form-label">Vendedor</label>
            <select class="form-select" name="vendedor">
              <option value="">{% if vendedores and (vendedores|length) > 0 %}Selecione um vendedor{% else %}Nenhum vendedor encontrado{% endif %}</option>
              {% for v in vendedores %}
                <option value="{{ v }}" {% if vendedor_selecionado == v %}selected{% endif %}>{{ v }}</option>
              {% endfor %}
            </select>
          </div>
        {% endif %}

        <div class="col-auto">
          <label class="form-label">MÃªs</label>
          <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
        </div>

        <div class="col-auto">
          <label class="form-label">Ano</label>
          <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
        </div>

        <div class="col-auto">
          <button id="filtersSubmit" class="btn btn-primary" type="submit">
            <span class="btn-label">Atualizar</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>

        <div class="col">
          <div class="text-end text-muted small">
            Dica: use <strong>vendedor</strong> para comparar desempenho por perfil.
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if dados %}
    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ’° Valor lÃ­quido (com DS/CA)</div>
            <div class="kpi-value display-6">R$ {{ dados.valor_atual|brl }}</div>
            <div class="kpi-foot">Ano passado: R$ {{ dados.valor_ano_passado|brl }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ“¦ Mix de produtos (itens Ãºnicos)</div>
            <div class="kpi-value display-6">{{ dados.mix_atual }}</div>
            <div class="kpi-foot">Ano passado: {{ dados.mix_ano_passado }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ§¾ Valor bruto (sem DS/CA)</div>
            <div class="kpi-value fs-2">R$ {{ dados.valor_bruto|brl }}</div>
            <div class="kpi-foot">Somente vendas</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">â†©ï¸ DevoluÃ§Ãµes/Cancelamentos (DS/CA)</div>
            <div class="kpi-value fs-2">R$ {{ dados.valor_devolvido|brl }}</div>
            <div class="kpi-foot">Total abatido</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ“‰ % devoluÃ§Ã£o (sobre bruto)</div>
            {% if dados.pct_devolucao is not none %}
              <div class="kpi-value fs-2">{{ "%.2f"|format(dados.pct_devolucao) }}%</div>
              <div class="kpi-foot">Devolvido Ã· Bruto</div>
            {% else %}
              <div class="kpi-value fs-2">â€”</div>
              <div class="kpi-foot">Sem base</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Crescimento -->
    <div class="glass card mb-3">
      <div class="card-body">
        <div class="section-title">
          <h5 class="fw-semibold mb-0">ğŸ“ˆ Crescimento vs mÃªs anterior (lÃ­quido)</h5>
          <div class="text-end">
            {% if dados.crescimento is not none %}
              {% if dados.crescimento >= 0 %}
                <span class="badge text-bg-success fs-6">+{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% else %}
                <span class="badge text-bg-danger fs-6">{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% endif %}
            {% else %}
              <span class="badge text-bg-secondary fs-6">Sem base</span>
            {% endif %}
          </div>
        </div>

        <div class="text-muted small mb-2">
          ComparaÃ§Ã£o do lÃ­quido do mÃªs selecionado com o mÃªs anterior.
        </div>

        {% if dados.crescimento is not none %}
          {% set grow = dados.crescimento %}
          {% set pct = (grow if grow < 100 else 100) %}
          {% set abs_pct = (pct if pct >= 0 else (-pct)) %}
          <div class="mini-bar" title="VariaÃ§Ã£o (%)">
            <span style="width: {{ abs_pct }}%"></span>
          </div>
          <div class="text-muted small mt-2">
            {% if grow >= 0 %}Cresceu{% else %}Caiu{% endif %} {{ "%.2f"|format(grow) }}% em relaÃ§Ã£o ao mÃªs anterior.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Insights -->
    {% if insights %}
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ† Cidade destaque</div>
            <div class="kpi-value fs-4">{{ insights.cidade_destaque.cidade_norm|default('â€”') }}</div>
            <div class="kpi-foot text-success">R$ {{ insights.cidade_destaque.total_vendido|default(0)|round(2) }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ“‰ Cidade em queda</div>
            {% if insights.cidade_queda %}
              <div class="kpi-value fs-4">{{ insights.cidade_queda.cidade_norm }}</div>
              <div class="kpi-foot text-danger">R$ {{ insights.cidade_queda.variacao|round(2) }}</div>
            {% else %}
              <div class="kpi-value fs-4">â€”</div>
              <div class="kpi-foot">Sem base comparativa</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ†• Clientes novos</div>
            <div class="kpi-value fs-2">{{ insights.clientes_novos|default(0) }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="glass card kpi h-100">
          <div class="card-body">
            <div class="kpi-label">ğŸ” Clientes recorrentes</div>
            <div class="kpi-value fs-2">{{ insights.clientes_recorrentes|default(0) }}</div>
          </div>
        </div>
      </div>
    </div>

    {% if insights.clientes_destaque %}
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <div class="glass card h-100">
          <div class="card-body">
            <div class="kpi-label">â­ Cliente destaque (â†‘ vs mÃªs anterior)</div>
            {% set c = (insights.clientes_destaque.crescimento[0] if insights.clientes_destaque.crescimento and insights.clientes_destaque.crescimento|length>0 else None) %}
            {% if c %}
              <div class="fw-semibold fs-5">{{ c.cliente }}</div>
              <div class="text-success fw-semibold mt-1">+ R$ {{ c.delta|round(2) }}{% if c.pct is not none %} ({{ c.pct|round(1) }}%) {% endif %}</div>
              <div class="text-muted small">Atual: R$ {{ c.atual|round(2) }} â€¢ Anterior: R$ {{ c.anterior|round(2) }}</div>
            {% else %}
              <div class="fw-semibold fs-5">â€”</div>
              <div class="text-muted small">Sem base comparativa</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="glass card h-100">
          <div class="card-body">
            <div class="kpi-label">âš ï¸ Cliente em queda (â†“ vs mÃªs anterior)</div>
            {% set q = (insights.clientes_destaque.queda[0] if insights.clientes_destaque.queda and insights.clientes_destaque.queda|length>0 else None) %}
            {% if q %}
              <div class="fw-semibold fs-5">{{ q.cliente }}</div>
              <div class="text-danger fw-semibold mt-1">R$ {{ q.delta|round(2) }}{% if q.pct is not none %} ({{ q.pct|round(1) }}%) {% endif %}</div>
              <div class="text-muted small">Atual: R$ {{ q.atual|round(2) }} â€¢ Anterior: R$ {{ q.anterior|round(2) }}</div>
            {% else %}
              <div class="fw-semibold fs-5">â€”</div>
              <div class="text-muted small">Sem base comparativa</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Ranking Top 15 -->
    <div class="glass card">
      <div class="card-body">
        <div class="section-title">
          <h5 class="fw-semibold mb-0">ğŸ“Š Top 15 marcas â€” Valor + % do total (lÃ­quido)</h5>
          <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-sm btn-outline-primary">Ver ranking completo</a>
        </div>

        {% if dados.ranking_top15_list is not none and (dados.ranking_top15_list|length) > 0 %}
          {% set maxv = (dados.ranking_top15_list[0].valor if dados.ranking_top15_list and (dados.ranking_top15_list|length)>0 else 0) %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:56px;">#</th>
                  <th>Marca</th>
                  <th style="width:160px;">&nbsp;</th>
                  <th class="text-end" style="width:160px;">Valor</th>
                  <th class="text-end" style="width:120px;">% do total</th>
                </tr>
              </thead>
              <tbody>
                {% for row in dados.ranking_top15_list %}
                  {% set w = ( (row.valor / maxv * 100) if maxv and maxv>0 else 0 ) %}
                  <tr>
                    <td class="text-muted">{{ loop.index }}</td>
                    <td class="fw-semibold">{{ row.marca }}</td>
                    <td>
                      <div class="mini-bar" title="ProporÃ§Ã£o vs maior marca">
                        <span style="width: {{ w }}%"></span>
                      </div>
                    </td>
                    <td class="text-end">R$ {{ row.valor|brl }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.pct) }}%</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">Sem dados no perÃ­odo.</div>
        {% endif %}
      </div>
    </div>

    <!-- AÃ§Ãµes -->
    <div class="mt-3 d-flex flex-wrap gap-2">
      <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-outline-primary">Ver ranking completo</a>
      <a href="/devolucoes?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-outline-warning">Ver devoluÃ§Ãµes</a>
      <a href="/itens_parados" class="btn btn-outline-light">Itens parados</a>
      <a href="/senha" class="btn btn-outline-light">Trocar senha</a>

      {% if role and role|lower == "admin" %}
        <a href="/admin/importar" class="btn btn-outline-light">Importar</a>
        <a href="/admin/usuarios" class="btn btn-outline-light">UsuÃ¡rios</a>
        <a href="/admin/campanhas" class="btn btn-outline-light">Campanhas</a>
        <a href="/admin/resumos_periodo" class="btn btn-outline-light">Resumos</a>
        <a href="/admin/itens_parados" class="btn btn-outline-light">Itens parados (admin)</a>
        <a href="/admin/configuracoes" class="btn btn-outline-light">ConfiguraÃ§Ãµes</a>
      {% endif %}
    </div>

  {% else %}
    <div class="glass card p-3">
      <div class="text-muted">Sem dados para o perÃ­odo selecionado.</div>
    </div>
  {% endif %}
</div>
{% endblock %}
