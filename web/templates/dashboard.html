{% extends "base.html" %}

{% block title %}Dashboard - {{ vendedor or usuario }}{% endblock %}

{% block extra_head %}
<style>
.table-sm td, .table-sm th { padding: .55rem; }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  // UX: evita cliques repetidos e mostra spinner ao atualizar filtros
  (function(){
    const form = document.getElementById('filtersForm');
    const btn = document.getElementById('filtersSubmit');
    if (!form || !btn) return;
    form.addEventListener('submit', function(){
      btn.disabled = true;
      const sp = btn.querySelector('.spinner-border');
      const lb = btn.querySelector('.btn-label');
      if (lb) lb.textContent = 'Carregando...';
      if (sp) sp.classList.remove('d-none');
    });
  })();
</script>
{% endblock %}

{% block content %}
<div class="sv-page">
<!-- INSIGHTS PARCIAIS -->
{% if insights %}
<div class="row g-3 mb-3">

  <div class="col-12 col-md-3">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">ğŸ† Cidade destaque</div>
        <div class="fw-bold fs-5">{{ insights.cidade_destaque.cidade_norm|default('â€”') }}</div>
        <div class="text-success fw-semibold">
          R$ {{ insights.cidade_destaque.total_vendido|default(0)|brl_rs }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">ğŸ“‰ Cidade em queda</div>
        {% if insights.cidade_queda %}
          <div class="fw-bold fs-5">{{ insights.cidade_queda.cidade_norm }}</div>
          <div class="text-danger fw-semibold">
            R$ {{ insights.cidade_queda.variacao|brl_rs }}
          </div>
        {% else %}
          <div class="fw-bold fs-5">â€”</div>
          <div class="text-muted">Sem base comparativa</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">ğŸ†• Clientes novos</div>
        <div class="fw-bold fs-4">{{ insights.clientes_novos|default(0) }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">ğŸ” Clientes recorrentes</div>
        <div class="fw-bold fs-4">{{ insights.clientes_recorrentes|default(0) }}</div>
      </div>
    </div>
  </div>


{% if insights and insights.clientes_destaque %}
<div class="row g-3 mb-3">
  <div class="col-12 col-md-6">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">â­ Cliente destaque (â†‘ vs mÃªs anterior)</div>
        {% set c = (insights.clientes_destaque.crescimento[0] if insights.clientes_destaque.crescimento and insights.clientes_destaque.crescimento|length>0 else None) %}
        {% if c %}
          <div class="fw-bold fs-5">{{ c.cliente }}</div>
          <div class="text-success fw-semibold">
            + R$ {{ c.delta|brl_rs }}{% if c.pct is not none %} ({{ c.pct|round(1) }}%) {% endif %}
          </div>
          <div class="text-muted small">Atual: R$ {{ c.atual|brl_rs }} â€¢ Anterior: R$ {{ c.anterior|brl_rs }}</div>
        {% else %}
          <div class="fw-bold fs-5">â€”</div>
          <div class="text-muted">Sem base comparativa</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6">
    <div class="sv-card h-100">
      <div class="sv-card-body">
        <div class="small text-muted">âš ï¸ Cliente em queda (â†“ vs mÃªs anterior)</div>
        {% set q = (insights.clientes_destaque.queda[0] if insights.clientes_destaque.queda and insights.clientes_destaque.queda|length>0 else None) %}
        {% if q %}
          <div class="fw-bold fs-5">{{ q.cliente }}</div>
          <div class="text-danger fw-semibold">
            R$ {{ q.delta|brl_rs }}{% if q.pct is not none %} ({{ q.pct|round(1) }}%) {% endif %}
          </div>
          <div class="text-muted small">Atual: R$ {{ q.atual|brl_rs }} â€¢ Anterior: R$ {{ q.anterior|brl_rs }}</div>
        {% else %}
          <div class="fw-bold fs-5">â€”</div>
          <div class="text-muted">Sem base comparativa</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

</div>
{% endif %}


    <div class="sv-card mb-3 d-flex flex-wrap align-items-start justify-content-between gap-3">
  <div>
    <div class="d-flex align-items-center flex-wrap gap-2">
      <div class="sv-h1">Dashboard</div>
      {% if role %}<span class="badge text-bg-dark">{{ role|upper }}</span>{% endif %}
      {% if role and role|lower == "supervisor" and emp %}<span class="badge text-bg-secondary">EMP {{ emp }}</span>{% endif %}
    </div>
    <div class="text-muted mt-1">
      Visualizando: <strong class="text-body">{{ vendedor or usuario }}</strong>
      <span class="mx-1">â€¢</span>
      PerÃ­odo: <strong class="text-body">{{ "%02d"|format(mes) }}/{{ ano }}</strong>
    </div>
    {% if mensagem_role %}
      <div class="alert alert-warning py-2 px-3 mt-2 mb-0">{{ mensagem_role }}</div>
    {% endif %}
  </div>
  <div class="d-flex align-items-center gap-2">
    <div class="dropdown">
  <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
    âš¡ AÃ§Ãµes rÃ¡pidas
  </button>
  <ul class="dropdown-menu dropdown-menu-end shadow-sm">
    {% if role and role|lower == "admin" %}
      <li><h6 class="dropdown-header">Admin</h6></li>
      <li><a class="dropdown-item" href="/admin/usuarios">ğŸ‘¥ UsuÃ¡rios</a></li>
      <li><a class="dropdown-item" href="/admin/importar">ğŸ“¥ Importar vendas</a></li>
      <li><a class="dropdown-item" href="/admin/itens_parados">ğŸ§Š Itens parados (Admin)</a></li>
      <li><a class="dropdown-item" href="/admin/resumos_periodo">ğŸ—“ï¸ Resumos (Ano passado)</a></li>
      <li><a class="dropdown-item" href="/admin/campanhas">ğŸ¯ Campanhas (Admin)</a></li>
      <li><hr class="dropdown-divider"></li>
    {% endif %}
    <li><a class="dropdown-item" href="/itens_parados">ğŸ§Š Itens parados</a></li>
    <li><a class="dropdown-item" href="/campanhas">ğŸ¯ Campanhas</a></li>
    <li><a class="dropdown-item" href="/relatorios/campanhas">ğŸ“Š RelatÃ³rio Campanhas</a></li>
    <li><a class="dropdown-item" href="/relatorios/cidades-clientes">ğŸ™ï¸ Cidades &amp; Clientes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="/senha">ğŸ”‘ Trocar senha</a></li>
    {% if role and role|lower == "admin" %}
      <li><a class="dropdown-item" href="/admin/configuracoes">âš™ï¸ ConfiguraÃ§Ãµes</a></li>
    {% endif %}
    <li><a class="dropdown-item text-danger" href="/logout">ğŸšª Sair</a></li>
  </ul>
</div>
  </div>
</div>

{% if admin_geral and dados_admin %}

  <div class="alert alert-info d-flex align-items-center gap-2 mb-3">
    <div><strong>VisÃ£o Geral</strong> â€” todos os vendedores do perÃ­odo. Use a tabela por EMP para comparar e abrir detalhes.</div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card shadow-sm kpi">
        <div class="sv-card-body">
          <div class="text-muted small">Total lÃ­quido (mÃªs)</div>
          <div class="fs-4 fw-bold">R$ {{ dados_admin.valor_atual|brl }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm kpi">
        <div class="sv-card-body">
          <div class="text-muted small">Bruto (sem devoluÃ§Ã£o)</div>
          <div class="fs-4 fw-bold">R$ {{ dados_admin.valor_bruto|brl }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm kpi">
        <div class="sv-card-body">
          <div class="text-muted small">Devolvido</div>
          <div class="fs-4 fw-bold">R$ {{ dados_admin.valor_devolvido|brl }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm kpi">
        <div class="sv-card-body">
          <div class="text-muted small">% devoluÃ§Ã£o</div>
          <div class="fs-4 fw-bold">{% if dados_admin.pct_devolucao is not none %}{{ "%.2f"|format(dados_admin.pct_devolucao) }}%{% else %}â€”{% endif %}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="sv-card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Ranking por EMP</h5>
            <span class="text-muted small">Clique para abrir Campanhas no perÃ­odo</span>
          </div>
          <div class="sv-tablewrap">
            <table class="sv-table align-middle">
              <thead>
                <tr>
                  <th>EMP</th>
                  <th class="text-end">LÃ­quido</th>
                  <th class="text-end">Bruto</th>
                  <th class="text-end">DevoluÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody>
                {% for row in (dados_admin.ranking_emp_list or []) %}
                  <tr class="sv-row-click" onclick="window.location='/campanhas?emp={{ row.emp }}&mes={{ mes }}&ano={{ ano }}'">
                    <td class="fw-semibold">{{ row.emp or "â€”" }}</td>
                    <td class="text-end fw-semibold">R$ {{ row.valor_atual|brl }}</td>
                    <td class="text-end text-muted">R$ {{ row.valor_bruto|brl }}</td>
                    <td class="text-end text-muted">R$ {{ row.valor_devolvido|brl }}</td>
                  </tr>
                {% endfor %}
                {% if not (dados_admin.ranking_emp_list or []) %}
                  <tr><td colspan="4" class="text-muted">Sem dados para o perÃ­odo.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="sv-card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Top vendedores (lÃ­quido)</h5>
            <span class="text-muted small">Clique para abrir Dashboard do vendedor</span>
          </div>
          <div class="sv-tablewrap">
            <table class="sv-table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Vendedor</th>
                  <th class="text-end">LÃ­quido</th>
                </tr>
              </thead>
              <tbody>
                {% for row in (dados_admin.ranking_vendedores_list or []) %}
                  <tr class="sv-row-click" onclick="window.location='/dashboard?vendedor={{ row.vendedor }}&mes={{ mes }}&ano={{ ano }}'">
                    <td class="fw-semibold">{{ row.vendedor }}</td>
                    <td class="text-end fw-semibold">R$ {{ row.valor|brl }}</td>
                  </tr>
                {% endfor %}
                {% if not (dados_admin.ranking_vendedores_list or []) %}
                  <tr><td colspan="2" class="text-muted">Sem dados.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

{% elif dados %}
  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="sv-card h-100">
        <div class="sv-card-body">
          <div class="text-muted small">ğŸ’° Valor lÃ­quido</div>
          <div class="fs-4 fw-bold">R$ {{ dados.valor_atual|brl }}</div>
          <div class="text-muted small mt-1">MÃªs anterior: R$ {{ dados.valor_mes_anterior|brl }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="sv-card h-100">
        <div class="sv-card-body">
          <div class="text-muted small">ğŸ“ˆ Crescimento</div>
          <div class="fs-4 fw-bold">
            {% if dados.crescimento is not none %}
              {{ (dados.crescimento*100)|round(2) }}%
            {% else %}
              â€”
            {% endif %}
          </div>
          <div class="text-muted small mt-1">Ano passado: R$ {{ dados.valor_ano_passado|brl }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="sv-card h-100">
        <div class="sv-card-body">
          <div class="text-muted small">ğŸ§º Mix (itens)</div>
          <div class="fs-4 fw-bold">{{ dados.mix_atual|default(0) }}</div>
          <div class="text-muted small mt-1">Ano passado: {{ dados.mix_ano_passado|default(0) }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="sv-card h-100">
        <div class="sv-card-body">
          <div class="text-muted small">â†©ï¸ DevoluÃ§Ã£o</div>
          <div class="fs-4 fw-bold">{{ (dados.pct_devolucao or 0)|round(2) }}%</div>
          <div class="text-muted small mt-1">Devolvido: R$ {{ dados.valor_devolvido|brl }}</div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
</div>
    </div>

    {% if role and role|lower == "admin" %}
      <div class="alert alert-info shadow-sm">
        VocÃª estÃ¡ logado como <strong>ADMIN</strong>. Selecione um vendedor abaixo para visualizar exatamente o mesmo painel que ele vÃª.
      </div>
    {% elif role and role|lower == "supervisor" %}
      <div class="alert alert-info shadow-sm">
        VocÃª estÃ¡ logado como <strong>SUPERVISOR</strong>{% if emp %} da EMP <strong>{{ emp }}</strong>{% endif %}. Selecione um vendedor para ver exatamente o mesmo painel que ele vÃª.
      </div>
    {% endif %}

    <div class="card mb-3 shadow-sm">
      <div class="sv-card-body">
        <form id="filtersForm" method="get" action="{{ url_for('dashboard') }}" class="row g-2 align-items-end">

          {% if role and role|lower in ["admin", "supervisor"] %}
            <div class="col-md-4">
              <label class="form-label">Vendedor</label>
              <select class="sv-select" name="vendedor">
                {% if role and role|lower in ["admin", "supervisor"] %}
                <option value="" {% if not vendedor_selecionado %}selected{% endif %}>Todos vendedores</option>
                {% endif %}
                <option value="" disabled>{% if vendedores and (vendedores|length) > 0 %}Selecione um vendedor especÃ­fico{% else %}Nenhum vendedor encontrado{% endif %}</option>
                {% for v in vendedores %}
                  <option value="{{ v }}" {% if vendedor_selecionado == v %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <div class="col-auto">
            <label class="form-label">MÃªs</label>
            <input class="sv-input" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
          </div>
          <div class="col-auto">
            <label class="form-label">Ano</label>
            <input class="sv-input" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
          </div>
          <div class="col-auto">
            <button id="filtersSubmit" class="sv-btn sv-btn-primary" type="submit">
              <span class="btn-label">Atualizar</span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
          <div class="col">
            <div class="text-end text-muted">PerÃ­odo selecionado: <strong>{{ mes }}/{{ ano }}</strong></div>
          </div>
        </form>
      </div>
    </div>

    {% if dados %}
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="sv-card-body">
              <div class="text-muted">ğŸ’° Valor lÃ­quido (com DS/CA)</div>
              <div class="display-6">R$ {{ dados.valor_atual|brl }}</div>
              <div class="text-muted mt-1">Ano passado: R$ {{ dados.valor_ano_passado|brl }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="sv-card-body">
              <div class="text-muted">ğŸ“¦ Mix de produtos</div>
              <div class="display-6">{{ dados.mix_atual }}</div>
              <div class="text-muted mt-1">Ano passado: {{ dados.mix_ano_passado }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="sv-card-body">
              <div class="text-muted">ğŸ§¾ Valor bruto (sem DS/CA)</div>
              <div class="h3 m-0">R$ {{ dados.valor_bruto|brl }}</div>
              <div class="text-muted">Somente vendas</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="sv-card-body">
              <div class="text-muted">â†©ï¸ DevoluÃ§Ãµes/Cancelamentos (DS/CA)</div>
              <div class="h3 m-0">R$ {{ dados.valor_devolvido|brl }}</div>
              <div class="text-muted">Total abatido</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="sv-card-body">
              <div class="text-muted">ğŸ“‰ % devoluÃ§Ã£o (sobre bruto)</div>
              {% if dados.pct_devolucao is not none %}
                <div class="h3 m-0">{{ "%.2f"|format(dados.pct_devolucao) }}%</div>
              {% else %}
                <div class="h3 m-0">â€”</div>
                <div class="text-muted">Sem base</div>
              {% endif %}
              <div class="text-muted">Devolvido Ã· Bruto</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 shadow-sm">
        <div class="sv-card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">ğŸ“ˆ Crescimento vs mÃªs anterior (lÃ­quido)</div>
            <div class="text-muted">ComparaÃ§Ã£o do lÃ­quido do mÃªs selecionado com o mÃªs anterior</div>
          </div>
          <div class="text-end">
            {% if dados.crescimento is not none %}
              {% if dados.crescimento >= 0 %}
                <span class="badge text-bg-success fs-6">+{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% else %}
                <span class="badge text-bg-danger fs-6">{{ "%.2f"|format(dados.crescimento) }}%</span>
              {% endif %}
            {% else %}
              <span class="badge text-bg-secondary fs-6">Sem base</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="sv-card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">ğŸ“Š Top 15 marcas â€” Valor + % do total (lÃ­quido)</h5>
            <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="sv-btn sv-btn-xs sv-btn-ghost">Ver ranking completo</a>
          </div>
          <hr class="my-2">

          {% if dados.ranking_top15_list is not none and (dados.ranking_top15_list|length) > 0 %}
            <div class="sv-tablewrap">
              <table class="sv-table align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width:60px;">#</th>
                    <th>Marca</th>
                    <th class="text-end">Valor</th>
                    <th class="text-end">% do total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in dados.ranking_top15_list %}
                    <tr>
                      <td class="text-muted">{{ loop.index }}</td>
                      <td>{{ row.marca }}</td>
                      <td class="text-end">R$ {{ row.valor|brl }}</td>
                      <td class="text-end">{{ "%.2f"|format(row.pct) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">Sem dados no perÃ­odo.</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="sv-btn sv-btn-ghost">Ver ranking completo</a>
        <a href="/devolucoes?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="sv-btn sv-btn-ghost">Ver devoluÃ§Ãµes (DS/CA)</a>
      </div>

    {% else %}
      <div class="alert alert-warning shadow-sm">
        {% if mensagem_role %}{{ mensagem_role }}{% else %}Nenhum dado encontrado para este vendedor.{% endif %}
      </div>
    {% endif %}

  </div>
{% endblock %}
