{% extends "base.html" %}

{% block title %}Dashboard - {{ vendedor or usuario }}{% endblock %}

{% block extra_head %}
<style>
  .table-sm td, .table-sm th { padding: .55rem; }
  .kpi-icon{font-size:1.05rem; opacity:.85}
  .kpi-value{font-size:1.55rem}
  .kpi-value.big{font-size:1.85rem}
  .brand-bar{height:10px}
  .brand-row:hover{background: rgba(148,163,184,.10)}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // UX: evita cliques repetidos e mostra spinner ao atualizar filtros
  (function(){
    const form = document.getElementById('filtersForm');
    const btn = document.getElementById('filtersSubmit');
    if (!form || !btn) return;
    form.addEventListener('submit', function(){
      btn.disabled = true;
      const sp = btn.querySelector('.spinner-border');
      const lb = btn.querySelector('.btn-label');
      if (lb) lb.textContent = 'Carregando...';
      if (sp) sp.classList.remove('d-none');
    });
  })();
</script>

{% if role and role|lower == "admin" and emp_compare %}
<script>
  (function(){
    const data = {{ emp_compare|tojson }};
    if (!data || !data.labels || data.labels.length === 0) return;

    const ctx1 = document.getElementById('empSalesChart');
    const ctx2 = document.getElementById('empUniqueChart');
    if (!ctx1 || !ctx2) return;

    new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Vendas (lÃ­quido) - R$',
          data: data.vendas,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Itens Ãºnicos (mix) - por EMP',
          data: data.itens_unicos,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  })();
</script>
{% endif %}
{% endblock %}

{% block content %}
<div class="container py-4 app-bg-grid">

  <!-- Header -->
  <div class="app-page-header d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
    <div>
      <div class="d-flex align-items-center flex-wrap gap-2">
        <h1 class="h3 m-0">Dashboard</h1>
        {% if role %}<span class="badge text-bg-dark">{{ role|upper }}</span>{% endif %}
        {% if role and role|lower == "supervisor" and emp %}<span class="badge text-bg-secondary">EMP {{ emp }}</span>{% endif %}
      </div>
      <div class="text-muted mt-1">
        Visualizando: <strong class="text-body">{{ vendedor or usuario }}</strong>
        <span class="mx-1">â€¢</span>
        PerÃ­odo: <strong class="text-body">{{ "%02d"|format(mes) }}/{{ ano }}</strong>
      </div>
      {% if mensagem_role %}
        <div class="alert alert-warning py-2 px-3 mt-2 mb-0">{{ mensagem_role }}</div>
      {% endif %}
    </div>

    <div class="d-flex align-items-center gap-2">
      <div class="dropdown">
        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          âš¡ AÃ§Ãµes rÃ¡pidas
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
          {% if role and role|lower == "admin" %}
            <li><h6 class="dropdown-header">Admin</h6></li>
            <li><a class="dropdown-item" href="/admin/usuarios">ğŸ‘¥ UsuÃ¡rios</a></li>
            <li><a class="dropdown-item" href="/admin/importar">ğŸ“¥ Importar vendas</a></li>
            <li><a class="dropdown-item" href="/admin/itens_parados">ğŸ§Š Itens parados (Admin)</a></li>
            <li><a class="dropdown-item" href="/admin/resumos_periodo">ğŸ—“ï¸ Resumos (Ano passado)</a></li>
            <li><a class="dropdown-item" href="/admin/campanhas">ğŸ¯ Campanhas (Admin)</a></li>
            <li><hr class="dropdown-divider"></li>
          {% endif %}
          <li><a class="dropdown-item" href="/itens_parados">ğŸ§Š Itens parados</a></li>
          <li><a class="dropdown-item" href="/campanhas">ğŸ¯ Campanhas</a></li>
          <li><a class="dropdown-item" href="/relatorios/campanhas">ğŸ“Š RelatÃ³rio Campanhas</a></li>
          <li><a class="dropdown-item" href="/relatorios/cidades-clientes">ğŸ™ï¸ Cidades &amp; Clientes</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="/senha">ğŸ”‘ Trocar senha</a></li>
          {% if role and role|lower == "admin" %}
            <li><a class="dropdown-item" href="/admin/configuracoes">âš™ï¸ ConfiguraÃ§Ãµes</a></li>
          {% endif %}
          <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">ğŸšª Sair</a></li>
        </ul>
      </div>
    </div>
  </div>

  {% if role and role|lower == "admin" %}
    <div class="alert alert-info shadow-sm">
      VocÃª estÃ¡ logado como <strong>ADMIN</strong>. Selecione um vendedor abaixo para visualizar exatamente o mesmo painel que ele vÃª.
    </div>
  {% elif role and role|lower == "supervisor" %}
    <div class="alert alert-info shadow-sm">
      VocÃª estÃ¡ logado como <strong>SUPERVISOR</strong>{% if emp %} da EMP <strong>{{ emp }}</strong>{% endif %}. Selecione um vendedor para ver exatamente o mesmo painel que ele vÃª.
    </div>
  {% endif %}

  <!-- Filters -->
  <div class="card bi-card glass mb-3">
    <div class="card-body">
      <form id="filtersForm" method="get" action="{{ url_for('dashboard') }}" class="row g-2 align-items-end">

        {% if role and role|lower in ["admin", "supervisor"] %}
          <div class="col-md-4">
            <label class="form-label">Vendedor</label>
            <select class="form-select" name="vendedor">
              <option value="">{% if vendedores and (vendedores|length) > 0 %}Selecione um vendedor{% else %}Nenhum vendedor encontrado{% endif %}</option>
              {% for v in vendedores %}
                <option value="{{ v }}" {% if vendedor_selecionado == v %}selected{% endif %}>{{ v }}</option>
              {% endfor %}
            </select>
          </div>
        {% endif %}

        {% if role and role|lower == "admin" %}
          <div class="col-md-4">
            <label class="form-label">Comparar EMPs</label>
            <select class="form-select" name="emps" multiple size="3">
              {% for e in emps_disponiveis %}
                <option value="{{ e }}" {% if emps_selecionadas and (e in emps_selecionadas) %}selected{% endif %}>EMP {{ e }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Segure <kbd>Ctrl</kbd> para selecionar mais de uma EMP.</div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Escopo</label>
            <select class="form-select" name="cmp_scope">
              <option value="geral" {% if (request.args.get('cmp_scope') or 'geral') == 'geral' %}selected{% endif %}>Geral</option>
              <option value="vendedor" {% if (request.args.get('cmp_scope') or '') == 'vendedor' %}selected{% endif %}{% if not vendedor_selecionado %} disabled{% endif %}>Do vendedor</option>
            </select>
          </div>
        {% endif %}

        

        <div class="col-6 col-md-2">
          <label class="form-label">MÃªs</label>
          <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Ano</label>
          <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button id="filtersSubmit" class="btn btn-primary" type="submit">
            <span class="btn-label">Atualizar</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>

        <div class="col">
          <div class="text-md-end text-muted">PerÃ­odo selecionado: <strong>{{ "%02d"|format(mes) }}/{{ ano }}</strong></div>
        </div>
      </form>
    </div>
  </div>

  {% if role and role|lower == "admin" and emp_compare %}
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-6">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div>
                <div class="kpi-title">ğŸ“Š Vendas por EMP</div>
                <div class="kpi-sub">PerÃ­odo: {{ "%02d"|format(mes) }}/{{ ano }} â€¢ Escopo: {% if emp_compare.scope == 'vendedor' %}vendedor{% else %}geral{% endif %}</div>
              </div>
            </div>
            <canvas id="empSalesChart" height="140"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div>
                <div class="kpi-title">ğŸ§© Itens Ãºnicos (mix) por EMP</div>
                <div class="kpi-sub">Contagem de produtos Ãºnicos vendidos (exclui DS/CA)</div>
              </div>
            </div>
            <canvas id="empUniqueChart" height="140"></canvas>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if not dados %}
    <div class="alert alert-warning shadow-sm">
      {% if mensagem_role %}{{ mensagem_role }}{% else %}Nenhum dado encontrado para este vendedor. Selecione um vendedor e clique em <strong>Atualizar</strong>.{% endif %}
    </div>
  {% else %}

    <!-- Insights (opcional) -->
    {% if insights %}
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-3">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">ğŸ† Cidade destaque</div>
              <div class="kpi-value big">{{ insights.cidade_destaque.cidade_norm|default('â€”') }}</div>
              <div class="kpi-sub text-success fw-semibold">R$ {{ insights.cidade_destaque.total_vendido|default(0)|brl }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">ğŸ“‰ Cidade em queda</div>
              {% if insights.cidade_queda %}
                <div class="kpi-value big">{{ insights.cidade_queda.cidade_norm }}</div>
                <div class="kpi-sub text-danger fw-semibold">R$ {{ insights.cidade_queda.variacao|default(0)|brl }}</div>
              {% else %}
                <div class="kpi-value big">â€”</div>
                <div class="kpi-sub">Sem base comparativa</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">ğŸ†• Clientes novos</div>
              <div class="kpi-value big">{{ insights.clientes_novos|default(0) }}</div>
              <div class="kpi-sub">No mÃªs</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">ğŸ” Clientes recorrentes</div>
              <div class="kpi-value big">{{ insights.clientes_recorrentes|default(0) }}</div>
              <div class="kpi-sub">No mÃªs</div>
            </div>
          </div>
        </div>
      </div>

      {% if insights.clientes_destaque %}
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">â­ Cliente destaque (â†‘ vs mÃªs anterior)</div>
              {% set c = (insights.clientes_destaque.crescimento[0] if insights.clientes_destaque.crescimento and insights.clientes_destaque.crescimento|length>0 else None) %}
              {% if c %}
                <div class="kpi-value">{{ c.cliente }}</div>
                <div class="text-success fw-semibold">+ R$ {{ c.delta|brl }}{% if c.pct is not none %} ({{ c.pct|round(1) }}%) {% endif %}</div>
                <div class="kpi-sub">Atual: R$ {{ c.atual|brl }} â€¢ Anterior: R$ {{ c.anterior|brl }}</div>
              {% else %}
                <div class="kpi-value">â€”</div>
                <div class="kpi-sub">Sem base comparativa</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card bi-card glass h-100">
            <div class="card-body">
              <div class="kpi-title">âš ï¸ Cliente em queda (â†“ vs mÃªs anterior)</div>
              {% set q = (insights.clientes_destaque.queda[0] if insights.clientes_destaque.queda and insights.clientes_destaque.queda|length>0 else None) %}
              {% if q %}
                <div class="kpi-value">{{ q.cliente }}</div>
                <div class="text-danger fw-semibold">R$ {{ q.delta|brl }}{% if q.pct is not none %} ({{ q.pct|round(1) }}%) {% endif %}</div>
                <div class="kpi-sub">Atual: R$ {{ q.atual|brl }} â€¢ Anterior: R$ {{ q.anterior|brl }}</div>
              {% else %}
                <div class="kpi-value">â€”</div>
                <div class="kpi-sub">Sem base comparativa</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="kpi-title">ğŸ’° Valor lÃ­quido</div>
                <div class="kpi-value">R$ {{ dados.valor_atual|brl }}</div>
                <div class="kpi-sub">MÃªs anterior: R$ {{ dados.valor_mes_anterior|brl }}</div>
              </div>
              <div class="kpi-icon">ğŸ“Œ</div>
            </div>
            {% set w = 50 %}
            {% if dados.valor_mes_anterior and dados.valor_mes_anterior|float > 0 %}
              {% set w = ((dados.valor_atual|float / dados.valor_mes_anterior|float) * 50) %}
            {% endif %}
            {% if w < 8 %}{% set w = 8 %}{% endif %}
            {% if w > 100 %}{% set w = 100 %}{% endif %}
            <div class="mini-bar mt-2" style="--w: {{ w|round(0) }}%"><span></span></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="kpi-title">ğŸ“ˆ Crescimento</div>
                <div class="kpi-value">
                  {% if dados.crescimento is not none %}
                    {{ (dados.crescimento*100)|round(2) }}%
                  {% else %}
                    â€”
                  {% endif %}
                </div>
                <div class="kpi-sub">Ano passado: R$ {{ dados.valor_ano_passado|brl }}</div>
              </div>
              <div class="kpi-icon">ğŸ“Š</div>
            </div>
            {% set gw = 50 %}
            {% if dados.crescimento is not none %}
              {% set gw = 50 + (dados.crescimento*100) %}
            {% endif %}
            {% if gw < 8 %}{% set gw = 8 %}{% endif %}
            {% if gw > 100 %}{% set gw = 100 %}{% endif %}
            <div class="mini-bar mt-2" style="--w: {{ gw|round(0) }}%"><span></span></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="kpi-title">ğŸ§º Mix (itens)</div>
                <div class="kpi-value">{{ dados.mix_atual|default(0) }}</div>
                <div class="kpi-sub">Ano passado: {{ dados.mix_ano_passado|default(0) }}</div>
              </div>
              <div class="kpi-icon">ğŸ§¾</div>
            </div>
            {% set mw = 50 %}
            {% if dados.mix_ano_passado and dados.mix_ano_passado|float > 0 %}
              {% set mw = ((dados.mix_atual|float / dados.mix_ano_passado|float) * 50) %}
            {% endif %}
            {% if mw < 8 %}{% set mw = 8 %}{% endif %}
            {% if mw > 100 %}{% set mw = 100 %}{% endif %}
            <div class="mini-bar mt-2" style="--w: {{ mw|round(0) }}%"><span></span></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bi-card glass h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="kpi-title">â†©ï¸ DevoluÃ§Ã£o</div>
                <div class="kpi-value">{{ (dados.pct_devolucao or 0)|round(2) }}%</div>
                <div class="kpi-sub">Devolvido: R$ {{ dados.valor_devolvido|brl }}</div>
              </div>
              <div class="kpi-icon">ğŸ§Š</div>
            </div>
            {% set dw = (dados.pct_devolucao or 0) %}
            {% if dw < 2 %}{% set dw = 2 %}{% endif %}
            {% if dw > 100 %}{% set dw = 100 %}{% endif %}
            <div class="mini-bar mt-2" style="--w: {{ dw|round(0) }}%"><span></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detalhes (bruto / devolvido) -->
    <div class="card bi-card glass mb-3">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-semibold">Detalhes do perÃ­odo</div>
          <div class="text-muted small">Bruto, DS/CA e comparativos para auditoria rÃ¡pida.</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <span class="pill mono">ğŸ§¾ Bruto: R$ {{ dados.valor_bruto|brl }}</span>
          <span class="pill mono">â†©ï¸ DS/CA: R$ {{ dados.valor_devolvido|brl }}</span>
          <span class="pill mono">ğŸ“Œ LÃ­quido: R$ {{ dados.valor_atual|brl }}</span>
        </div>
      </div>
    </div>

    <!-- Top marcas -->
    <div class="card bi-card glass">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <h5 class="m-0">ğŸ“Š Top 15 marcas</h5>
            <div class="text-muted small">Valor + participaÃ§Ã£o no total (lÃ­quido).</div>
          </div>
          <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-sm btn-outline-primary">Ver ranking completo</a>
        </div>
        <hr class="my-2">

        {% if dados.ranking_top15_list is not none and (dados.ranking_top15_list|length) > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0 table-bi">
              <thead>
                <tr>
                  <th style="width:52px;">#</th>
                  <th>Marca</th>
                  <th style="width:220px;">ParticipaÃ§Ã£o</th>
                  <th class="text-end">Valor</th>
                  <th class="text-end">% do total</th>
                </tr>
              </thead>
              <tbody>
                {% for row in dados.ranking_top15_list %}
                  {% set bw = row.pct %}
                  {% if bw < 1 %}{% set bw = 1 %}{% endif %}
                  {% if bw > 100 %}{% set bw = 100 %}{% endif %}
                  <tr class="brand-row">
                    <td class="text-muted">{{ loop.index }}</td>
                    <td class="fw-semibold">{{ row.marca }}</td>
                    <td>
                      <div class="mini-bar brand-bar" style="--w: {{ bw|round(0) }}%"><span></span></div>
                    </td>
                    <td class="text-end mono">R$ {{ row.valor|brl }}</td>
                    <td class="text-end mono">{{ "%.2f"|format(row.pct) }}%</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">Sem dados no perÃ­odo.</div>
        {% endif %}
      </div>
    </div>

    <div class="mt-3 d-flex flex-wrap gap-2">
      <a href="/percentuais?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-outline-primary">Ver ranking completo</a>
      <a href="/devolucoes?mes={{ mes }}&ano={{ ano }}{% if vendedor_selecionado %}&vendedor={{ vendedor_selecionado }}{% endif %}" class="btn btn-outline-secondary">Ver devoluÃ§Ãµes (DS/CA)</a>
    </div>

  {% endif %}

</div>
{% endblock %}
