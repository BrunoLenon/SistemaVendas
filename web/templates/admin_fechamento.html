{% extends "base.html" %}
{% from "partials/multiselect.html" import multiselect %}

{% block title %}Fechamento Mensal — {{ mes }}/{{ ano }}{% endblock %}

{% block extra_head %}
<style>
  .page-title{font-weight:800; letter-spacing:-.3px}
  .subtitle{color:var(--bs-secondary-color)}
  .kpi{min-height:84px}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h3 class="m-0 page-title">✅ Fechamento Mensal</h3>
      <div class="subtitle mt-1">
        Trava edição de campanhas/resumos no período. Apenas ADMIN.
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_resumos_periodo') }}">Ir para Resumos por Período</a>
    </div>
  </div>

  {% if msgs %}
    {% for m in msgs %}
      <div class="alert alert-info py-2 mb-2">{{ m|safe }}</div>
    {% endfor %}
  {% endif %}

  <form method="get" action="{{ url_for('admin_fechamento') }}" class="filter-bar mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        {{ multiselect("emp", emps_options or [], emps_sel or [], label="EMP(s)", placeholder="Selecione EMP(s)") }}
        <div class="form-text">Você pode selecionar 1 ou várias EMPs para fechar/reabrir em lote.</div>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Mês</label>
        <input class="form-control" type="number" name="mes" min="1" max="12" value="{{ mes }}" required>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Ano</label>
        <input class="form-control" type="number" name="ano" min="2000" max="2100" value="{{ ano }}" required>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-primary" type="submit">Carregar</button>
      </div>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
        <div>
          <h5 class="m-0">Status do período</h5>
          <div class="subtitle small mt-1">Competência: <b>{{ mes }}/{{ ano }}</b></div>
        </div>

    <form method="post" action="{{ url_for('admin_fechamento') }}" class="d-flex flex-wrap gap-2 align-items-end">
          {# mantém filtros no POST #}
          {% for e in (emps_sel or []) %}
            <input type="hidden" name="emp" value="{{ e }}">
          {% endfor %}
          <input type="hidden" name="mes" value="{{ mes }}">
          <input type="hidden" name="ano" value="{{ ano }}">

                  
<button class="btn btn-primary" type="submit" name="acao" value="fechar_a_pagar" {% if not emps_sel %}disabled{% endif %}>
  Fechar (A pagar)
</button>
<button class="btn btn-success" type="submit" name="acao" value="fechar_pago" {% if not emps_sel %}disabled{% endif %}>
  Fechar (Pago)
</button>
<button class="btn btn-outline-secondary" type="submit" name="acao" value="reabrir" {% if not emps_sel %}disabled{% endif %}>
  Reabrir (Voltar para Aberto)
</button>
</form>
      </div>

      <div class="mt-3">
        {% if not emps_sel %}
          <div class="alert alert-warning mb-0">Selecione ao menos 1 EMP para ver o status e executar o fechamento.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>EMP</th>
                  <th>Trava</th>
                  <th>Financeiro</th>
                  <th>Fechado em</th>
                </tr>
              </thead>
              <tbody>
                {% for e in emps_sel %}
                  {% set st = status_por_emp.get(e) %}
                  <tr>
                    <td><b>{{ e }}</b></td>
                    <td>
                      {% if st and st.fechado %}
                        <span class="badge text-bg-danger">FECHADO</span>
                      {% else %}
                        <span class="badge text-bg-success">ABERTO</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if st and st.status == "pago" %}
                        <span class="badge text-bg-primary">PAGO</span>
                      {% elif st and st.status == "a_pagar" %}
                        <span class="badge text-bg-warning">A PAGAR</span>
                      {% else %}
                        <span class="badge text-bg-secondary">ABERTO</span>
                      {% endif %}
                    </td>
                    <td class="small text-muted">
                      {% if st and st.fechado_em %}
                        {{ st.fechado_em }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="alert alert-secondary small mb-0">
            <b>Dica:</b> Se o mês estiver <span class="badge text-bg-danger">FECHADO</span>, telas que respeitam a trava não devem permitir alteração dos cadastros do período.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}